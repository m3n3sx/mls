<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MASE Background Lazy Loading Test</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen-Sans, Ubuntu, Cantarell, "Helvetica Neue", sans-serif;
        }
        
        .test-section {
            margin-bottom: 40px;
            padding: 20px;
            border: 2px solid #ddd;
            border-radius: 8px;
        }
        
        .test-section h2 {
            margin-top: 0;
            color: #0073aa;
        }
        
        .bg-container {
            width: 100%;
            height: 400px;
            margin: 20px 0;
            border: 2px solid #ccc;
            border-radius: 4px;
            position: relative;
            background-color: #f0f0f0;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }
        
        .bg-container.mase-bg-loaded {
            border-color: #46b450;
        }
        
        .bg-container.mase-bg-error {
            border-color: #dc3232;
        }
        
        .bg-label {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .status-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .status-loading {
            background: #ffb900;
            color: #000;
        }
        
        .status-loaded {
            background: #46b450;
            color: #fff;
        }
        
        .status-error {
            background: #dc3232;
            color: #fff;
        }
        
        .spacer {
            height: 800px;
            background: linear-gradient(to bottom, #f0f0f0, #e0e0e0);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: #666;
            margin: 20px 0;
        }
        
        .info-box {
            background: #e7f5fe;
            border-left: 4px solid #0073aa;
            padding: 15px;
            margin: 20px 0;
        }
        
        .info-box h3 {
            margin-top: 0;
            color: #0073aa;
        }
        
        .test-results {
            margin-top: 20px;
            padding: 15px;
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .test-results h3 {
            margin-top: 0;
        }
        
        .test-result-item {
            padding: 8px;
            margin: 5px 0;
            border-radius: 4px;
        }
        
        .test-result-item.pass {
            background: #d4edda;
            color: #155724;
        }
        
        .test-result-item.fail {
            background: #f8d7da;
            color: #721c24;
        }
        
        .test-result-item.pending {
            background: #fff3cd;
            color: #856404;
        }
    </style>
</head>
<body>
    <h1>MASE Background Lazy Loading Test</h1>
    
    <div class="info-box">
        <h3>Test Instructions</h3>
        <p>This page tests the lazy loading functionality for background images (Task 30).</p>
        <ul>
            <li>Scroll down to see background images load as they enter the viewport</li>
            <li>Images should load approximately 50px before entering the viewport</li>
            <li>Loaded images will have a green border</li>
            <li>Failed images will have a red border</li>
            <li>Check the console for detailed logging</li>
        </ul>
    </div>
    
    <div class="test-section">
        <h2>Test 1: Immediate Load (Above Fold)</h2>
        <p>This image should load immediately as it's visible on page load.</p>
        <div class="bg-container" data-bg-lazy="https://picsum.photos/800/400?random=1">
            <div class="bg-label">Image 1 - Above Fold</div>
            <div class="status-indicator status-loading">Loading...</div>
        </div>
    </div>
    
    <div class="spacer">
        ↓ Scroll Down ↓
    </div>
    
    <div class="test-section">
        <h2>Test 2: Lazy Load (Below Fold)</h2>
        <p>This image should load when you scroll near it (50px margin).</p>
        <div class="bg-container" data-bg-lazy="https://picsum.photos/800/400?random=2">
            <div class="bg-label">Image 2 - Below Fold</div>
            <div class="status-indicator status-loading">Loading...</div>
        </div>
    </div>
    
    <div class="spacer">
        ↓ Scroll Down ↓
    </div>
    
    <div class="test-section">
        <h2>Test 3: Multiple Images</h2>
        <p>Multiple images should load independently as they enter viewport.</p>
        <div class="bg-container" data-bg-lazy="https://picsum.photos/800/400?random=3">
            <div class="bg-label">Image 3</div>
            <div class="status-indicator status-loading">Loading...</div>
        </div>
        <div class="bg-container" data-bg-lazy="https://picsum.photos/800/400?random=4">
            <div class="bg-label">Image 4</div>
            <div class="status-indicator status-loading">Loading...</div>
        </div>
    </div>
    
    <div class="spacer">
        ↓ Scroll Down ↓
    </div>
    
    <div class="test-section">
        <h2>Test 4: Error Handling</h2>
        <p>This image URL is invalid and should trigger error handling.</p>
        <div class="bg-container" data-bg-lazy="https://invalid-url-that-does-not-exist.com/image.jpg">
            <div class="bg-label">Image 5 - Invalid URL</div>
            <div class="status-indicator status-loading">Loading...</div>
        </div>
    </div>
    
    <div class="test-results">
        <h3>Test Results</h3>
        <div id="test-results-container">
            <div class="test-result-item pending">⏳ Waiting for tests to complete...</div>
        </div>
    </div>
    
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        // Mock MASE object structure
        var MASE = {
            config: {
                ajaxUrl: '',
                nonce: '',
                debounceDelay: 300,
                autoSaveDelay: 2000,
                noticeTimeout: 3000
            },
            i18n: {},
            state: {
                livePreviewEnabled: false,
                currentPalette: null,
                currentTemplate: null,
                isDirty: false,
                isSaving: false,
                isApplyingPalette: false,
                isApplyingTemplate: false
            }
        };
    </script>
    <script src="../assets/js/mase-admin.js"></script>
    <script>
        (function($) {
            'use strict';
            
            // Test tracking
            var testResults = {
                observerSupport: false,
                imagesLoaded: 0,
                imagesErrored: 0,
                totalImages: 5
            };
            
            // Check IntersectionObserver support
            testResults.observerSupport = 'IntersectionObserver' in window;
            
            // Update status indicators when images load
            $(document).on('DOMNodeInserted', function(e) {
                var $target = $(e.target);
                if ($target.hasClass('mase-bg-loaded')) {
                    $target.find('.status-indicator')
                        .removeClass('status-loading')
                        .addClass('status-loaded')
                        .text('Loaded ✓');
                    testResults.imagesLoaded++;
                    updateTestResults();
                }
                if ($target.hasClass('mase-bg-error')) {
                    $target.find('.status-indicator')
                        .removeClass('status-loading')
                        .addClass('status-error')
                        .text('Error ✗');
                    testResults.imagesErrored++;
                    updateTestResults();
                }
            });
            
            // Monitor class changes using MutationObserver
            var observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                        var $target = $(mutation.target);
                        if ($target.hasClass('mase-bg-loaded')) {
                            $target.find('.status-indicator')
                                .removeClass('status-loading')
                                .addClass('status-loaded')
                                .text('Loaded ✓');
                            testResults.imagesLoaded++;
                            updateTestResults();
                        }
                        if ($target.hasClass('mase-bg-error')) {
                            $target.find('.status-indicator')
                                .removeClass('status-loading')
                                .addClass('status-error')
                                .text('Error ✗');
                            testResults.imagesErrored++;
                            updateTestResults();
                        }
                    }
                });
            });
            
            // Observe all bg-containers
            $('.bg-container').each(function() {
                observer.observe(this, { attributes: true });
            });
            
            function updateTestResults() {
                var html = '';
                
                // Test 1: IntersectionObserver support
                html += '<div class="test-result-item ' + (testResults.observerSupport ? 'pass' : 'fail') + '">';
                html += testResults.observerSupport ? '✓' : '✗';
                html += ' IntersectionObserver Support: ' + (testResults.observerSupport ? 'Supported' : 'Not Supported (using fallback)');
                html += '</div>';
                
                // Test 2: Images loaded
                html += '<div class="test-result-item ' + (testResults.imagesLoaded > 0 ? 'pass' : 'pending') + '">';
                html += testResults.imagesLoaded > 0 ? '✓' : '⏳';
                html += ' Images Loaded: ' + testResults.imagesLoaded + ' / ' + (testResults.totalImages - 1);
                html += '</div>';
                
                // Test 3: Error handling
                html += '<div class="test-result-item ' + (testResults.imagesErrored > 0 ? 'pass' : 'pending') + '">';
                html += testResults.imagesErrored > 0 ? '✓' : '⏳';
                html += ' Error Handling: ' + (testResults.imagesErrored > 0 ? 'Working' : 'Pending');
                html += '</div>';
                
                // Test 4: Lazy loading working
                var lazyLoadWorking = testResults.imagesLoaded > 0 || testResults.imagesErrored > 0;
                html += '<div class="test-result-item ' + (lazyLoadWorking ? 'pass' : 'pending') + '">';
                html += lazyLoadWorking ? '✓' : '⏳';
                html += ' Lazy Loading: ' + (lazyLoadWorking ? 'Working' : 'Pending');
                html += '</div>';
                
                $('#test-results-container').html(html);
            }
            
            // Initialize test results
            $(document).ready(function() {
                console.log('=== MASE Background Lazy Loading Test ===');
                console.log('IntersectionObserver supported:', testResults.observerSupport);
                
                // Initialize backgrounds module
                if (typeof MASE !== 'undefined' && typeof MASE.backgrounds !== 'undefined') {
                    MASE.backgrounds.init();
                    console.log('MASE backgrounds module initialized');
                } else {
                    console.error('MASE backgrounds module not found!');
                }
                
                updateTestResults();
                
                // Auto-scroll test (optional)
                setTimeout(function() {
                    console.log('Auto-scrolling to test lazy loading...');
                    $('html, body').animate({ scrollTop: 1000 }, 2000);
                }, 2000);
            });
            
        })(jQuery);
    </script>
</body>
</html>
