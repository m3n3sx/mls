<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dark Mode Screen Reader Announcements Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .test-container {
            background: white;
            border-radius: 8px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .test-description {
            color: #7f8c8d;
            margin-bottom: 30px;
            line-height: 1.6;
        }
        
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 6px;
            border-left: 4px solid #3498db;
        }
        
        .test-section h2 {
            margin-top: 0;
            color: #2c3e50;
            font-size: 18px;
        }
        
        .test-button {
            background: #3498db;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
            margin-bottom: 10px;
            transition: background 0.2s;
        }
        
        .test-button:hover {
            background: #2980b9;
        }
        
        .test-button:focus {
            outline: 3px solid #3498db;
            outline-offset: 2px;
        }
        
        .status {
            padding: 10px 15px;
            border-radius: 4px;
            margin-top: 15px;
            font-weight: 500;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .log-container {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 15px;
        }
        
        .log-entry {
            margin-bottom: 8px;
            padding: 5px;
            border-left: 3px solid #3498db;
            padding-left: 10px;
        }
        
        .log-entry.announcement {
            border-left-color: #2ecc71;
        }
        
        .log-entry.error {
            border-left-color: #e74c3c;
        }
        
        .timestamp {
            color: #95a5a6;
            font-size: 12px;
        }
        
        /* Dark mode styles */
        body.mase-dark-mode {
            background-color: #1a1a1a;
            color: #e0e0e0;
        }
        
        body.mase-dark-mode .test-container {
            background: #2d2d2d;
        }
        
        body.mase-dark-mode h1,
        body.mase-dark-mode .test-section h2 {
            color: #e0e0e0;
        }
        
        body.mase-dark-mode .test-description {
            color: #b0b0b0;
        }
        
        body.mase-dark-mode .test-section {
            background: #3a3a3a;
            border-left-color: #4a9eff;
        }
        
        /* FAB styles */
        .mase-dark-mode-fab {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: #0073aa;
            color: white;
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            transition: all 0.3s ease;
            z-index: 9999;
        }
        
        .mase-dark-mode-fab:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }
        
        .mase-dark-mode-fab:focus {
            outline: 3px solid #4a9eff;
            outline-offset: 2px;
        }
        
        .mase-icon-rotating {
            animation: rotate360 0.3s ease-in-out;
        }
        
        @keyframes rotate360 {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        /* Screen reader only styles */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }
        
        #mase-sr-announcements {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }
        
        .announcement-display {
            background: #fff3cd;
            border: 1px solid #ffc107;
            color: #856404;
            padding: 15px;
            border-radius: 6px;
            margin-top: 15px;
            font-weight: 500;
        }
        
        body.mase-dark-mode .announcement-display {
            background: #4a4a00;
            border-color: #ffc107;
            color: #ffd700;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>🔊 Dark Mode Screen Reader Announcements Test</h1>
        <p class="test-description">
            Task 13: Testing screen reader announcements for dark mode toggle.
            This test verifies that mode changes are properly announced to screen readers
            using ARIA live regions and that all ARIA attributes are updated correctly.
        </p>

        <!-- Test Section 1: ARIA Live Region -->
        <div class="test-section">
            <h2>Test 1: ARIA Live Region Creation</h2>
            <p>Verify that the ARIA live region is created on initialization.</p>
            <button class="test-button" onclick="testAriaLiveRegion()">Test ARIA Live Region</button>
            <div id="test1-status"></div>
        </div>

        <!-- Test Section 2: Screen Reader Announcements -->
        <div class="test-section">
            <h2>Test 2: Screen Reader Announcements</h2>
            <p>Toggle dark mode and verify announcements are made to screen readers.</p>
            <button class="test-button" onclick="testScreenReaderAnnouncement()">Toggle & Announce</button>
            <div id="test2-status"></div>
            <div id="announcement-display"></div>
        </div>

        <!-- Test Section 3: FAB ARIA Attributes -->
        <div class="test-section">
            <h2>Test 3: FAB ARIA Attributes</h2>
            <p>Verify that FAB aria-pressed and aria-label are updated on mode change.</p>
            <button class="test-button" onclick="testFabAriaAttributes()">Test ARIA Attributes</button>
            <div id="test3-status"></div>
        </div>

        <!-- Test Section 4: SR-Only Text -->
        <div class="test-section">
            <h2>Test 4: SR-Only Text Update</h2>
            <p>Verify that the sr-only text in the FAB is updated to reflect current mode.</p>
            <button class="test-button" onclick="testSrOnlyText()">Test SR-Only Text</button>
            <div id="test4-status"></div>
        </div>

        <!-- Test Section 5: Keyboard Shortcut Announcement -->
        <div class="test-section">
            <h2>Test 5: Keyboard Shortcut Announcement</h2>
            <p>Press Ctrl+Shift+D (or Cmd+Shift+D on Mac) to toggle and verify announcement.</p>
            <div class="status info">
                Press <strong>Ctrl+Shift+D</strong> (Windows/Linux) or <strong>Cmd+Shift+D</strong> (Mac) to test
            </div>
            <div id="test5-status"></div>
        </div>

        <!-- Test Section 6: Multiple Rapid Toggles -->
        <div class="test-section">
            <h2>Test 6: Multiple Rapid Toggles</h2>
            <p>Test that announcements work correctly even with rapid mode changes.</p>
            <button class="test-button" onclick="testRapidToggles()">Test Rapid Toggles</button>
            <div id="test6-status"></div>
        </div>

        <!-- Event Log -->
        <div class="test-section">
            <h2>📋 Event Log</h2>
            <button class="test-button" onclick="clearLog()">Clear Log</button>
            <div class="log-container" id="event-log"></div>
        </div>
    </div>

    <!-- Include jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    
    <script>
        // Mock MASE object with dark mode toggle functionality
        var MASE = {
            config: {
                ajaxUrl: '/wp-admin/admin-ajax.php',
                nonce: 'test-nonce'
            },
            
            darkModeToggle: {
                config: {
                    fabSelector: '.mase-dark-mode-fab',
                    bodyClass: 'mase-dark-mode',
                    storageKey: 'mase_dark_mode',
                    transitionDuration: 300,
                    keyboardShortcut: { ctrl: true, shift: true, key: 'D' }
                },
                
                state: {
                    currentMode: 'light',
                    isTransitioning: false,
                    systemPreference: null,
                    userPreference: null
                },
                
                init: function() {
                    var self = this;
                    logEvent('Initializing dark mode toggle');
                    
                    // Create ARIA live region
                    self.createAriaLiveRegion();
                    
                    // Render FAB
                    self.render();
                    
                    // Setup keyboard shortcuts
                    self.setupKeyboardShortcuts();
                    
                    logEvent('Dark mode initialized - Current mode: ' + self.state.currentMode);
                },
                
                createAriaLiveRegion: function() {
                    var self = this;
                    
                    try {
                        if ($('#mase-sr-announcements').length > 0) {
                            logEvent('ARIA live region already exists');
                            return;
                        }
                        
                        var liveRegionHtml = '<div id="mase-sr-announcements" ' +
                            'class="sr-only" ' +
                            'role="status" ' +
                            'aria-live="polite" ' +
                            'aria-atomic="true">' +
                            '</div>';
                        
                        $('body').append(liveRegionHtml);
                        logEvent('ARIA live region created', 'announcement');
                    } catch (error) {
                        logEvent('Error creating ARIA live region: ' + error.message, 'error');
                    }
                },
                
                announceToScreenReader: function(message) {
                    var self = this;
                    
                    try {
                        var $liveRegion = $('#mase-sr-announcements');
                        
                        if ($liveRegion.length === 0) {
                            self.createAriaLiveRegion();
                            $liveRegion = $('#mase-sr-announcements');
                        }
                        
                        // Clear previous announcement
                        $liveRegion.text('');
                        
                        // Use setTimeout to ensure screen readers detect the change
                        setTimeout(function() {
                            $liveRegion.text(message);
                            logEvent('Screen reader announcement: ' + message, 'announcement');
                            
                            // Display announcement visually for testing
                            $('#announcement-display').html(
                                '<div class="announcement-display">📢 Announced: "' + message + '"</div>'
                            );
                            
                            // Clear announcement after 1 second
                            setTimeout(function() {
                                $liveRegion.text('');
                            }, 1000);
                        }, 100);
                    } catch (error) {
                        logEvent('Error announcing to screen reader: ' + error.message, 'error');
                    }
                },
                
                render: function() {
                    var self = this;
                    
                    try {
                        if ($(self.config.fabSelector).length > 0) {
                            logEvent('FAB already rendered');
                            return;
                        }
                        
                        var iconClass = self.state.currentMode === 'dark' ? '☀️' : '🌙';
                        var ariaLabel = self.state.currentMode === 'dark' ? 'Switch to Light Mode' : 'Switch to Dark Mode';
                        var ariaPressed = self.state.currentMode === 'dark' ? 'true' : 'false';
                        var srText = self.state.currentMode === 'dark' ? 'Dark mode active' : 'Light mode active';
                        
                        var fabHtml = '<button class="mase-dark-mode-fab" ' +
                            'aria-label="' + ariaLabel + '" ' +
                            'aria-pressed="' + ariaPressed + '" ' +
                            'role="switch" ' +
                            'title="' + ariaLabel + '">' +
                            '<span class="icon" aria-hidden="true">' + iconClass + '</span>' +
                            '<span class="sr-only">' + srText + '</span>' +
                            '</button>';
                        
                        $('body').append(fabHtml);
                        
                        // Attach click handler
                        $(self.config.fabSelector).on('click', function() {
                            self.toggle();
                        });
                        
                        logEvent('FAB rendered successfully');
                    } catch (error) {
                        logEvent('Error rendering FAB: ' + error.message, 'error');
                    }
                },
                
                toggle: function() {
                    var self = this;
                    var newMode = self.state.currentMode === 'light' ? 'dark' : 'light';
                    self.setMode(newMode);
                },
                
                setMode: function(mode) {
                    var self = this;
                    
                    if (self.state.isTransitioning) {
                        logEvent('Mode transition already in progress');
                        return;
                    }
                    
                    self.state.isTransitioning = true;
                    self.state.currentMode = mode;
                    
                    // Apply mode
                    self.applyMode(mode, true);
                    
                    // Announce mode change to screen readers
                    var announcement = mode === 'dark' ? 'Dark mode activated' : 'Light mode activated';
                    self.announceToScreenReader(announcement);
                    
                    // Update icon and ARIA attributes
                    self.updateIcon();
                    
                    // Animate icon
                    self.animateIcon();
                    
                    logEvent('Mode changed to: ' + mode);
                    
                    setTimeout(function() {
                        self.state.isTransitioning = false;
                    }, self.config.transitionDuration);
                },
                
                applyMode: function(mode, animate) {
                    var $body = $('body');
                    
                    if (mode === 'dark') {
                        $body.addClass(this.config.bodyClass);
                    } else {
                        $body.removeClass(this.config.bodyClass);
                    }
                },
                
                updateIcon: function() {
                    var self = this;
                    var $fab = $(self.config.fabSelector);
                    
                    if ($fab.length === 0) {
                        return;
                    }
                    
                    var iconClass = self.state.currentMode === 'dark' ? '☀️' : '🌙';
                    var ariaLabel = self.state.currentMode === 'dark' ? 'Switch to Light Mode' : 'Switch to Dark Mode';
                    var ariaPressed = self.state.currentMode === 'dark' ? 'true' : 'false';
                    var srText = self.state.currentMode === 'dark' ? 'Dark mode active' : 'Light mode active';
                    
                    $fab.find('.icon').text(iconClass);
                    $fab.attr('aria-label', ariaLabel);
                    $fab.attr('aria-pressed', ariaPressed);
                    $fab.attr('title', ariaLabel);
                    $fab.find('.sr-only').text(srText);
                    
                    logEvent('FAB icon and ARIA attributes updated');
                },
                
                animateIcon: function() {
                    var self = this;
                    var $fab = $(self.config.fabSelector);
                    
                    if ($fab.length) {
                        var $icon = $fab.find('.icon');
                        $icon.addClass('mase-icon-rotating');
                        
                        setTimeout(function() {
                            $icon.removeClass('mase-icon-rotating');
                        }, self.config.transitionDuration);
                    }
                },
                
                setupKeyboardShortcuts: function() {
                    var self = this;
                    
                    $(document).on('keydown', function(e) {
                        var isModifierPressed = e.ctrlKey || e.metaKey;
                        var isShiftPressed = e.shiftKey;
                        var isDKey = e.key === 'D' || e.key === 'd';
                        
                        if (isModifierPressed && isShiftPressed && isDKey) {
                            e.preventDefault();
                            self.toggle();
                            logEvent('Dark mode toggled via keyboard shortcut');
                        }
                    });
                    
                    logEvent('Keyboard shortcuts initialized');
                }
            }
        };
        
        // Event logging
        function logEvent(message, type = 'info') {
            var timestamp = new Date().toLocaleTimeString();
            var logEntry = '<div class="log-entry ' + type + '">' +
                '<span class="timestamp">[' + timestamp + ']</span> ' + message +
                '</div>';
            
            $('#event-log').prepend(logEntry);
        }
        
        function clearLog() {
            $('#event-log').empty();
            logEvent('Log cleared');
        }
        
        // Test functions
        function testAriaLiveRegion() {
            var $liveRegion = $('#mase-sr-announcements');
            var statusDiv = $('#test1-status');
            
            if ($liveRegion.length === 0) {
                statusDiv.html('<div class="status error">❌ FAILED: ARIA live region not found</div>');
                return;
            }
            
            // Check attributes
            var hasRole = $liveRegion.attr('role') === 'status';
            var hasAriaLive = $liveRegion.attr('aria-live') === 'polite';
            var hasAriaAtomic = $liveRegion.attr('aria-atomic') === 'true';
            var hasSrOnlyClass = $liveRegion.hasClass('sr-only');
            
            if (hasRole && hasAriaLive && hasAriaAtomic && hasSrOnlyClass) {
                statusDiv.html('<div class="status success">✅ PASSED: ARIA live region created with correct attributes</div>');
                logEvent('Test 1 PASSED: ARIA live region verified');
            } else {
                statusDiv.html('<div class="status error">❌ FAILED: ARIA live region missing required attributes</div>');
                logEvent('Test 1 FAILED: Missing attributes', 'error');
            }
        }
        
        function testScreenReaderAnnouncement() {
            MASE.darkModeToggle.toggle();
            
            setTimeout(function() {
                var $liveRegion = $('#mase-sr-announcements');
                var announcement = $liveRegion.text();
                var statusDiv = $('#test2-status');
                
                if (announcement && (announcement.includes('activated') || announcement.includes('mode'))) {
                    statusDiv.html('<div class="status success">✅ PASSED: Announcement made to screen readers</div>');
                    logEvent('Test 2 PASSED: Screen reader announcement verified');
                } else {
                    statusDiv.html('<div class="status error">❌ FAILED: No announcement detected</div>');
                    logEvent('Test 2 FAILED: No announcement', 'error');
                }
            }, 200);
        }
        
        function testFabAriaAttributes() {
            var $fab = $('.mase-dark-mode-fab');
            var statusDiv = $('#test3-status');
            
            if ($fab.length === 0) {
                statusDiv.html('<div class="status error">❌ FAILED: FAB not found</div>');
                return;
            }
            
            var currentMode = MASE.darkModeToggle.state.currentMode;
            var expectedAriaPressed = currentMode === 'dark' ? 'true' : 'false';
            var expectedAriaLabel = currentMode === 'dark' ? 'Switch to Light Mode' : 'Switch to Dark Mode';
            
            var actualAriaPressed = $fab.attr('aria-pressed');
            var actualAriaLabel = $fab.attr('aria-label');
            
            if (actualAriaPressed === expectedAriaPressed && actualAriaLabel === expectedAriaLabel) {
                statusDiv.html('<div class="status success">✅ PASSED: FAB ARIA attributes correct for ' + currentMode + ' mode</div>');
                logEvent('Test 3 PASSED: ARIA attributes verified');
            } else {
                statusDiv.html('<div class="status error">❌ FAILED: ARIA attributes incorrect</div>');
                logEvent('Test 3 FAILED: ARIA attributes mismatch', 'error');
            }
        }
        
        function testSrOnlyText() {
            var $fab = $('.mase-dark-mode-fab');
            var $srText = $fab.find('.sr-only');
            var statusDiv = $('#test4-status');
            
            if ($srText.length === 0) {
                statusDiv.html('<div class="status error">❌ FAILED: SR-only text not found</div>');
                return;
            }
            
            var currentMode = MASE.darkModeToggle.state.currentMode;
            var expectedText = currentMode === 'dark' ? 'Dark mode active' : 'Light mode active';
            var actualText = $srText.text();
            
            if (actualText === expectedText) {
                statusDiv.html('<div class="status success">✅ PASSED: SR-only text correct: "' + actualText + '"</div>');
                logEvent('Test 4 PASSED: SR-only text verified');
            } else {
                statusDiv.html('<div class="status error">❌ FAILED: SR-only text incorrect. Expected: "' + expectedText + '", Got: "' + actualText + '"</div>');
                logEvent('Test 4 FAILED: SR-only text mismatch', 'error');
            }
        }
        
        function testRapidToggles() {
            var statusDiv = $('#test6-status');
            statusDiv.html('<div class="status info">⏳ Testing rapid toggles...</div>');
            
            var toggleCount = 0;
            var maxToggles = 5;
            var interval = setInterval(function() {
                if (toggleCount < maxToggles) {
                    MASE.darkModeToggle.toggle();
                    toggleCount++;
                } else {
                    clearInterval(interval);
                    
                    setTimeout(function() {
                        var $liveRegion = $('#mase-sr-announcements');
                        statusDiv.html('<div class="status success">✅ PASSED: Completed ' + maxToggles + ' rapid toggles without errors</div>');
                        logEvent('Test 6 PASSED: Rapid toggles completed');
                    }, 500);
                }
            }, 400);
        }
        
        // Monitor keyboard shortcuts
        $(document).on('keydown', function(e) {
            var isModifierPressed = e.ctrlKey || e.metaKey;
            var isShiftPressed = e.shiftKey;
            var isDKey = e.key === 'D' || e.key === 'd';
            
            if (isModifierPressed && isShiftPressed && isDKey) {
                var statusDiv = $('#test5-status');
                statusDiv.html('<div class="status success">✅ PASSED: Keyboard shortcut triggered announcement</div>');
                logEvent('Test 5 PASSED: Keyboard shortcut announcement verified');
            }
        });
        
        // Initialize on page load
        $(document).ready(function() {
            MASE.darkModeToggle.init();
            logEvent('Page loaded and tests ready');
        });
    </script>
</body>
</html>
