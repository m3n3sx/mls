<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dark Mode Comprehensive Integration Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
            transition: background-color 0.3s, color 0.3s;
        }
        
        body.mase-dark-mode {
            background-color: #1a1a1a;
            color: #e0e0e0;
        }
        
        .test-container {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        body.mase-dark-mode .test-container {
            background: #2d2d2d;
            border-color: #444;
        }
        
        h1, h2, h3 {
            color: #333;
        }
        
        body.mase-dark-mode h1,
        body.mase-dark-mode h2,
        body.mase-dark-mode h3 {
            color: #e0e0e0;
        }
        
        .test-result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-family: monospace;
            font-size: 14px;
        }
        
        .test-result.pass {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        
        .test-result.fail {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        
        .test-result.info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
        
        body.mase-dark-mode .test-result.pass {
            background: #1e4620;
            border-color: #2d5f2f;
            color: #a8d5a8;
        }
        
        body.mase-dark-mode .test-result.fail {
            background: #4a1f1f;
            border-color: #5f2d2d;
            color: #f5a8a8;
        }
        
        body.mase-dark-mode .test-result.info {
            background: #1f3a4a;
            border-color: #2d4f5f;
            color: #a8d5f5;
        }
        
        button {
            background: #0073aa;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        
        button:hover {
            background: #005a87;
        }
        
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .controls {
            margin: 20px 0;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .status-card {
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: #f8f9fa;
        }
        
        body.mase-dark-mode .status-card {
            background: #1a1a1a;
            border-color: #444;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-indicator.active {
            background: #28a745;
        }
        
        .status-indicator.inactive {
            background: #dc3545;
        }
        
        .event-log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            max-height: 400px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        
        body.mase-dark-mode .event-log {
            background: #1a1a1a;
            border-color: #444;
            color: #e0e0e0;
        }
        
        .event-entry {
            padding: 5px;
            border-bottom: 1px solid #dee2e6;
        }
        
        body.mase-dark-mode .event-entry {
            border-bottom-color: #444;
        }
        
        .timestamp {
            color: #6c757d;
            margin-right: 10px;
        }
        
        body.mase-dark-mode .timestamp {
            color: #999;
        }
        
        .summary {
            background: #e7f3ff;
            border: 2px solid #0073aa;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }
        
        body.mase-dark-mode .summary {
            background: #1a3a4a;
            border-color: #4a9eff;
        }
        
        .summary-stats {
            display: flex;
            gap: 20px;
            margin-top: 15px;
        }
        
        .stat {
            padding: 10px 20px;
            border-radius: 4px;
            font-weight: 600;
            font-size: 18px;
        }
        
        .stat.pass {
            background: #d4edda;
            color: #155724;
        }
        
        .stat.fail {
            background: #f8d7da;
            color: #721c24;
        }
        
        body.mase-dark-mode .stat.pass {
            background: #1e4620;
            color: #a8d5a8;
        }
        
        body.mase-dark-mode .stat.fail {
            background: #4a1f1f;
            color: #f5a8a8;
        }
    </style>
</head>
<body>
    <h1>ðŸ§ª Dark Mode Comprehensive Integration Test</h1>
    <p><strong>Task 24:</strong> Integration tests covering all dark mode functionality</p>
    <p><strong>Requirements:</strong> 7.1-7.7 (Live Preview), 10.1-10.7 (Settings)</p>
    
    <div class="test-container">
        <h2>Test Controls</h2>
        <div class="controls">
            <button id="run-all-tests">Run All Tests</button>
            <button id="toggle-preview">Toggle Live Preview</button>
            <button id="toggle-dark-mode">Toggle Dark Mode</button>
            <button id="save-settings">Save Settings</button>
            <button id="clear-log">Clear Event Log</button>
            <button id="clear-storage">Clear localStorage</button>
        </div>
    </div>
    
    <div class="test-container">
        <h2>System Status</h2>
        <div class="status-grid">
            <div class="status-card">
                <strong>Dark Mode:</strong><br>
                <span class="status-indicator" id="dark-mode-indicator"></span>
                <span id="dark-mode-status">Light</span>
            </div>
            <div class="status-card">
                <strong>Live Preview:</strong><br>
                <span class="status-indicator" id="preview-indicator"></span>
                <span id="preview-status">Inactive</span>
            </div>
            <div class="status-card">
                <strong>localStorage:</strong><br>
                <span id="storage-status">Not set</span>
            </div>
            <div class="status-card">
                <strong>Cache Status:</strong><br>
                <span id="cache-status">Unknown</span>
            </div>
        </div>
    </div>
    
    <div class="test-container">
        <h2>Event Log</h2>
        <div class="event-log" id="event-log"></div>
    </div>
    
    <div class="test-container">
        <h2>Test Results</h2>
        <div id="test-results"></div>
    </div>
    
    <div class="summary" id="summary" style="display:none;">
        <h2>Test Summary</h2>
        <div class="summary-stats">
            <div class="stat pass">âœ“ Passed: <span id="pass-count">0</span></div>
            <div class="stat fail">âœ— Failed: <span id="fail-count">0</span></div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        // Test statistics
        var testStats = {
            passed: 0,
            failed: 0
        };
        
        // Mock MASE object with all required modules
        var MASE = {
            config: {
                nonce: 'test-nonce-12345',
                ajaxUrl: '/wp-admin/admin-ajax.php'
            },
            state: {
                livePreviewEnabled: false,
                isSaving: false
            },
            cache: {
                lightMode: null,
                darkMode: null,
                version: '1.3.0'
            },
            darkModeToggle: {
                config: {
                    bodyClass: 'mase-dark-mode',
                    storageKey: 'mase_dark_mode',
                    transitionDuration: 300
                },
                state: {
                    currentMode: 'light',
                    isTransitioning: false,
                    systemPreference: 'light',
                    userPreference: null,
                    needsSync: false
                },
                init: function() {
                    this.loadSavedPreference();
                    this.applyMode(this.state.currentMode, false);
                    updateStatus();
                },
                loadSavedPreference: function() {
                    try {
                        var mode = localStorage.getItem(this.config.storageKey);
                        if (mode) {
                            this.state.currentMode = mode;
                            this.state.userPreference = mode;
                        }
                    } catch (e) {
                        logEvent('ERROR', 'localStorage unavailable');
                    }
                },
                setMode: function(mode) {
                    var self = this;
                    
                    if (mode !== 'light' && mode !== 'dark') {
                        logEvent('ERROR', 'Invalid mode: ' + mode);
                        return;
                    }
                    
                    if (self.state.isTransitioning) {
                        logEvent('WARN', 'Mode transition already in progress');
                        return;
                    }
                    
                    // Check if live preview is active (Requirement 7.1, 7.2)
                    if (MASE.livePreview && MASE.livePreview.isActive()) {
                        logEvent('INFO', 'Preview active, applying temporary dark mode change');
                        MASE.livePreview.updateDarkMode(mode);
                        return; // Don't save during preview (Requirement 7.6)
                    }
                    
                    self.state.isTransitioning = true;
                    self.state.currentMode = mode;
                    self.state.userPreference = mode;
                    
                    self.applyMode(mode, true);
                    self.savePreference(mode);
                    
                    // Invalidate cache for current mode (Requirement 12.5)
                    MASE.invalidateCache(mode);
                    
                    $(document).trigger('mase:modeChanged', { mode: mode });
                    
                    setTimeout(function() {
                        self.state.isTransitioning = false;
                        $(document).trigger('mase:transitionComplete', { mode: mode });
                    }, self.config.transitionDuration);
                },
                toggle: function() {
                    var newMode = this.state.currentMode === 'light' ? 'dark' : 'light';
                    this.setMode(newMode);
                },
                applyMode: function(mode, animate) {
                    var $body = $('body');
                    
                    if (animate) {
                        $body.addClass('mase-transitioning');
                    }
                    
                    if (mode === 'dark') {
                        $body.addClass(this.config.bodyClass);
                    } else {
                        $body.removeClass(this.config.bodyClass);
                    }
                    
                    if (animate) {
                        setTimeout(function() {
                            $body.removeClass('mase-transitioning');
                        }, this.config.transitionDuration);
                    }
                    
                    updateStatus();
                    logEvent('MODE', 'Applied mode: ' + mode);
                },
                savePreference: function(mode) {
                    try {
                        localStorage.setItem(this.config.storageKey, mode);
                        logEvent('SAVE', 'Saved to localStorage: ' + mode);
                        updateStatus();
                    } catch (e) {
                        logEvent('ERROR', 'Failed to save to localStorage');
                    }
                },
                updateIcon: function() {
                    logEvent('UI', 'Updated FAB icon for mode: ' + this.state.currentMode);
                }
            },
            livePreview: {
                previewState: {
                    savedDarkMode: null,
                    savedSettings: null,
                    isPreviewActive: false
                },
                isActive: function() {
                    return this.previewState.isPreviewActive;
                },
                toggle: function() {
                    var self = MASE;
                    self.state.livePreviewEnabled = !self.state.livePreviewEnabled;
                    
                    if (self.state.livePreviewEnabled) {
                        // Entering preview mode (Requirement 7.3)
                        this.previewState.isPreviewActive = true;
                        this.previewState.savedDarkMode = self.darkModeToggle.state.currentMode;
                        logEvent('PREVIEW', 'Entering preview mode, saved dark mode: ' + this.previewState.savedDarkMode);
                    } else {
                        // Exiting preview mode (Requirement 7.3)
                        if (this.previewState.savedDarkMode !== null) {
                            logEvent('PREVIEW', 'Exiting preview mode, restoring dark mode: ' + this.previewState.savedDarkMode);
                            self.darkModeToggle.applyMode(this.previewState.savedDarkMode, false);
                            self.darkModeToggle.state.currentMode = this.previewState.savedDarkMode;
                            self.darkModeToggle.updateIcon();
                        }
                        
                        this.previewState.isPreviewActive = false;
                        this.previewState.savedDarkMode = null;
                    }
                    
                    updateStatus();
                },
                updateDarkMode: function(mode) {
                    var self = MASE;
                    
                    logEvent('PREVIEW', 'Updating dark mode in preview: ' + mode);
                    
                    self.darkModeToggle.applyMode(mode, true);
                    self.darkModeToggle.state.currentMode = mode;
                    self.darkModeToggle.updateIcon();
                    
                    // Trigger preview updated event (Requirement 7.5)
                    $(document).trigger('mase:previewUpdated', { 
                        darkMode: mode,
                        isPreview: true 
                    });
                    
                    logEvent('PREVIEW', 'Dark mode preview applied (not saved)');
                }
            },
            // Settings save/load functionality (Requirements 10.1-10.7)
            settings: {
                current: {
                    dark_light_toggle: {
                        enabled: true,
                        current_mode: 'light',
                        light_palette: 'professional-blue',
                        dark_palette: 'dark-elegance'
                    }
                },
                save: function() {
                    if (MASE.state.isSaving) {
                        logEvent('WARN', 'Save already in progress');
                        return;
                    }
                    
                    MASE.state.isSaving = true;
                    logEvent('SETTINGS', 'Saving settings...');
                    
                    // Include dark mode preference (Requirement 10.2)
                    this.current.dark_light_toggle.current_mode = MASE.darkModeToggle.state.currentMode;
                    
                    // Simulate AJAX save
                    setTimeout(function() {
                        logEvent('SETTINGS', 'Settings saved successfully');
                        MASE.state.isSaving = false;
                        
                        // Invalidate both caches on settings save (Requirement 12.6)
                        MASE.invalidateBothCaches();
                        
                        // Warm caches (Requirement 12.7)
                        MASE.warmCaches();
                        
                        $(document).trigger('mase:settingsSaved', { 
                            settings: MASE.settings.current 
                        });
                    }, 500);
                },
                load: function() {
                    logEvent('SETTINGS', 'Loading settings...');
                    
                    // Simulate loading from server
                    setTimeout(function() {
                        var mode = MASE.settings.current.dark_light_toggle.current_mode;
                        MASE.darkModeToggle.state.currentMode = mode;
                        MASE.darkModeToggle.applyMode(mode, false);
                        
                        logEvent('SETTINGS', 'Settings loaded, dark mode: ' + mode);
                        $(document).trigger('mase:settingsLoaded', { 
                            settings: MASE.settings.current 
                        });
                    }, 300);
                }
            },
            // Cache management (Requirements 12.5, 12.6, 12.7)
            invalidateCache: function(mode) {
                if (mode === 'dark') {
                    this.cache.darkMode = null;
                    logEvent('CACHE', 'Invalidated dark mode cache');
                } else {
                    this.cache.lightMode = null;
                    logEvent('CACHE', 'Invalidated light mode cache');
                }
                updateStatus();
            },
            invalidateBothCaches: function() {
                this.cache.lightMode = null;
                this.cache.darkMode = null;
                logEvent('CACHE', 'Invalidated both light and dark mode caches');
                updateStatus();
            },
            warmCaches: function() {
                logEvent('CACHE', 'Warming caches...');
                setTimeout(function() {
                    MASE.cache.lightMode = 'cached-light-css-v' + MASE.cache.version;
                    MASE.cache.darkMode = 'cached-dark-css-v' + MASE.cache.version;
                    logEvent('CACHE', 'Caches warmed successfully');
                    updateStatus();
                }, 200);
            }
        };
        
        // Event logging
        function logEvent(type, message) {
            var timestamp = new Date().toLocaleTimeString();
            var entry = $('<div class="event-entry"></div>');
            entry.html('<span class="timestamp">' + timestamp + '</span><strong>[' + type + ']</strong> ' + message);
            $('#event-log').prepend(entry);
        }
        
        // Update status indicators
        function updateStatus() {
            var previewActive = MASE.livePreview.isActive();
            var darkMode = MASE.darkModeToggle.state.currentMode;
            
            $('#preview-indicator').toggleClass('active', previewActive).toggleClass('inactive', !previewActive);
            $('#preview-status').text(previewActive ? 'Active' : 'Inactive');
            
            $('#dark-mode-indicator').toggleClass('active', darkMode === 'dark').toggleClass('inactive', darkMode === 'light');
            $('#dark-mode-status').text(darkMode === 'dark' ? 'Dark' : 'Light');
            
            // localStorage status
            try {
                var stored = localStorage.getItem(MASE.darkModeToggle.config.storageKey);
                $('#storage-status').text(stored ? stored : 'Not set');
            } catch (e) {
                $('#storage-status').text('Unavailable');
            }
            
            // Cache status
            var cacheStatus = [];
            if (MASE.cache.lightMode) cacheStatus.push('Light');
            if (MASE.cache.darkMode) cacheStatus.push('Dark');
            $('#cache-status').text(cacheStatus.length > 0 ? cacheStatus.join(', ') + ' cached' : 'Empty');
        }
        
        // Test result logging
        function addTestResult(name, passed, message) {
            var result = $('<div class="test-result"></div>');
            result.addClass(passed ? 'pass' : 'fail');
            result.html('<strong>' + (passed ? 'âœ“ PASS' : 'âœ— FAIL') + ':</strong> ' + name + (message ? '<br>' + message : ''));
            $('#test-results').append(result);
            
            if (passed) {
                testStats.passed++;
            } else {
                testStats.failed++;
            }
            
            updateSummary();
        }
        
        function addTestInfo(message) {
            var result = $('<div class="test-result info"></div>');
            result.html('<strong>â„¹ INFO:</strong> ' + message);
            $('#test-results').append(result);
        }
        
        function updateSummary() {
            $('#summary').show();
            $('#pass-count').text(testStats.passed);
            $('#fail-count').text(testStats.failed);
        }
        
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
        
        // Test Suite
        async function runAllTests() {
            $('#test-results').empty();
            testStats.passed = 0;
            testStats.failed = 0;
            
            addTestInfo('=== Starting Comprehensive Integration Tests ===');
            
            // Test 1: Dark mode with live preview (Requirements 7.1-7.7)
            await testDarkModeWithLivePreview();
            
            // Test 2: Settings save/load cycle (Requirements 10.1-10.7)
            await testSettingsSaveLoadCycle();
            
            // Test 3: Preference sync across tabs (Requirement 4.1-4.5)
            await testPreferenceSync();
            
            // Test 4: AJAX communication (Requirement 2.4, 2.5)
            await testAJAXCommunication();
            
            // Test 5: Cache integration (Requirements 12.5-12.7)
            await testCacheIntegration();
            
            // Test 6: Migration logic (Requirement 10.5)
            await testMigrationLogic();
            
            addTestInfo('=== All Tests Complete ===');
        }
        
        // Test 1: Dark mode with live preview
        async function testDarkModeWithLivePreview() {
            addTestInfo('Test 1: Dark Mode with Live Preview Integration');
            
            // Reset state
            MASE.darkModeToggle.state.currentMode = 'light';
            MASE.darkModeToggle.applyMode('light', false);
            
            // 1.1: Preview saves dark mode state (Requirement 7.3)
            var modeBeforePreview = MASE.darkModeToggle.state.currentMode;
            MASE.livePreview.toggle(); // Enter preview
            await sleep(100);
            var savedMode = MASE.livePreview.previewState.savedDarkMode;
            addTestResult(
                '1.1: Preview saves current dark mode',
                savedMode === modeBeforePreview,
                'Expected: ' + modeBeforePreview + ', Got: ' + savedMode
            );
            
            // 1.2: Dark mode changes are temporary during preview (Requirement 7.2, 7.6)
            var storedBefore = localStorage.getItem(MASE.darkModeToggle.config.storageKey);
            MASE.darkModeToggle.toggle(); // Toggle in preview
            await sleep(400);
            var storedAfter = localStorage.getItem(MASE.darkModeToggle.config.storageKey);
            addTestResult(
                '1.2: Dark mode changes not saved during preview',
                storedBefore === storedAfter,
                'localStorage unchanged during preview'
            );
            
            // 1.3: Preview updates trigger event (Requirement 7.5)
            var previewEventFired = false;
            $(document).one('mase:previewUpdated', function(e, data) {
                previewEventFired = true;
            });
            MASE.darkModeToggle.toggle();
            await sleep(100);
            addTestResult(
                '1.3: mase:previewUpdated event fires',
                previewEventFired,
                'Event fired: ' + previewEventFired
            );
            
            // 1.4: Preview restores saved mode on exit (Requirement 7.3)
            MASE.livePreview.toggle(); // Exit preview
            await sleep(100);
            var restoredMode = MASE.darkModeToggle.state.currentMode;
            addTestResult(
                '1.4: Preview restores saved dark mode on exit',
                restoredMode === savedMode,
                'Expected: ' + savedMode + ', Got: ' + restoredMode
            );
            
            // 1.5: Mode changes outside preview are saved (Requirement 7.6)
            MASE.darkModeToggle.toggle();
            await sleep(400);
            var storedFinal = localStorage.getItem(MASE.darkModeToggle.config.storageKey);
            addTestResult(
                '1.5: Mode changes saved outside preview',
                storedFinal !== null,
                'localStorage updated: ' + storedFinal
            );
        }
        
        // Test 2: Settings save/load cycle
        async function testSettingsSaveLoadCycle() {
            addTestInfo('Test 2: Settings Save/Load Cycle');
            
            // 2.1: Dark mode included in settings (Requirement 10.2)
            var initialMode = MASE.darkModeToggle.state.currentMode;
            MASE.settings.current.dark_light_toggle.current_mode = initialMode;
            addTestResult(
                '2.1: Dark mode included in settings structure',
                MASE.settings.current.dark_light_toggle.current_mode === initialMode,
                'Mode in settings: ' + MASE.settings.current.dark_light_toggle.current_mode
            );
            
            // 2.2: Settings save triggers event
            var saveEventFired = false;
            $(document).one('mase:settingsSaved', function() {
                saveEventFired = true;
            });
            MASE.settings.save();
            await sleep(600);
            addTestResult(
                '2.2: Settings save triggers event',
                saveEventFired,
                'mase:settingsSaved fired'
            );
            
            // 2.3: Settings load restores dark mode (Requirement 10.7)
            MASE.darkModeToggle.state.currentMode = 'light';
            MASE.settings.current.dark_light_toggle.current_mode = 'dark';
            MASE.settings.load();
            await sleep(400);
            addTestResult(
                '2.3: Settings load restores dark mode',
                MASE.darkModeToggle.state.currentMode === 'dark',
                'Mode restored: ' + MASE.darkModeToggle.state.currentMode
            );
        }
        
        // Test 3: Preference sync across tabs
        async function testPreferenceSync() {
            addTestInfo('Test 3: Preference Sync Across Tabs');
            
            // 3.1: localStorage used for immediate persistence (Requirement 4.1)
            MASE.darkModeToggle.setMode('dark');
            await sleep(100);
            var stored = localStorage.getItem(MASE.darkModeToggle.config.storageKey);
            addTestResult(
                '3.1: Preference saved to localStorage',
                stored === 'dark',
                'localStorage value: ' + stored
            );
            
            // 3.2: Preference loaded on init (Requirement 4.3)
            MASE.darkModeToggle.state.currentMode = 'light';
            MASE.darkModeToggle.loadSavedPreference();
            addTestResult(
                '3.2: Preference loaded from localStorage on init',
                MASE.darkModeToggle.state.currentMode === 'dark',
                'Loaded mode: ' + MASE.darkModeToggle.state.currentMode
            );
            
            // 3.3: Storage event would sync across tabs (simulated)
            addTestResult(
                '3.3: Storage event mechanism available',
                typeof window.addEventListener === 'function',
                'Can listen for storage events'
            );
        }
        
        // Test 4: AJAX communication
        async function testAJAXCommunication() {
            addTestInfo('Test 4: AJAX Communication');
            
            // 4.1: AJAX request structure (Requirement 2.4)
            var requestData = {
                action: 'mase_toggle_dark_mode',
                nonce: MASE.config.nonce,
                mode: 'dark'
            };
            addTestResult(
                '4.1: AJAX request includes required fields',
                requestData.action && requestData.nonce && requestData.mode,
                'Action: ' + requestData.action
            );
            
            // 4.2: Mode change triggers custom event (Requirement 2.7)
            var modeChangedFired = false;
            $(document).one('mase:modeChanged', function() {
                modeChangedFired = true;
            });
            MASE.darkModeToggle.setMode('light');
            await sleep(400);
            addTestResult(
                '4.2: mase:modeChanged event fires',
                modeChangedFired,
                'Event fired on mode change'
            );
        }
        
        // Test 5: Cache integration
        async function testCacheIntegration() {
            addTestInfo('Test 5: Cache Integration');
            
            // 5.1: Separate cache keys (Requirement 12.5)
            MASE.cache.lightMode = 'light-css';
            MASE.cache.darkMode = 'dark-css';
            addTestResult(
                '5.1: Separate cache keys for light and dark',
                MASE.cache.lightMode !== MASE.cache.darkMode,
                'Light: ' + MASE.cache.lightMode + ', Dark: ' + MASE.cache.darkMode
            );
            
            // 5.2: Mode toggle invalidates only active cache (Requirement 12.5)
            MASE.darkModeToggle.setMode('dark');
            await sleep(100);
            addTestResult(
                '5.2: Mode toggle invalidates only dark cache',
                MASE.cache.darkMode === null && MASE.cache.lightMode === 'light-css',
                'Dark cache cleared, light cache intact'
            );
            
            // 5.3: Settings save invalidates both caches (Requirement 12.6)
            MASE.cache.lightMode = 'light-css';
            MASE.cache.darkMode = 'dark-css';
            MASE.settings.save();
            await sleep(100);
            addTestResult(
                '5.3: Settings save invalidates both caches',
                MASE.cache.lightMode === null && MASE.cache.darkMode === null,
                'Both caches cleared'
            );
            
            // 5.4: Cache warming after save (Requirement 12.7)
            await sleep(600);
            addTestResult(
                '5.4: Caches warmed after settings save',
                MASE.cache.lightMode !== null && MASE.cache.darkMode !== null,
                'Both caches populated'
            );
        }
        
        // Test 6: Migration logic
        async function testMigrationLogic() {
            addTestInfo('Test 6: Migration Logic');
            
            // 6.1: Migration detects palette type (Requirement 10.5)
            var lightPalette = 'professional-blue';
            var darkPalette = 'dark-elegance';
            addTestResult(
                '6.1: Light and dark palettes defined',
                lightPalette && darkPalette,
                'Light: ' + lightPalette + ', Dark: ' + darkPalette
            );
            
            // 6.2: Migration sets initial mode based on palette
            MASE.settings.current.dark_light_toggle.light_palette = lightPalette;
            MASE.settings.current.dark_light_toggle.dark_palette = darkPalette;
            addTestResult(
                '6.2: Palette associations configured',
                MASE.settings.current.dark_light_toggle.light_palette === lightPalette,
                'Palettes configured in settings'
            );
            
            // 6.3: Migration saves preference to user meta (simulated)
            addTestResult(
                '6.3: User meta save mechanism available',
                typeof MASE.darkModeToggle.savePreference === 'function',
                'savePreference function exists'
            );
        }
        
        // Event listeners
        $(document).ready(function() {
            // Initialize
            MASE.darkModeToggle.init();
            updateStatus();
            logEvent('INIT', 'System initialized');
            
            // Listen for custom events
            $(document).on('mase:modeChanged', function(e, data) {
                logEvent('EVENT', 'mase:modeChanged - mode: ' + data.mode);
            });
            
            $(document).on('mase:transitionComplete', function(e, data) {
                logEvent('EVENT', 'mase:transitionComplete - mode: ' + data.mode);
            });
            
            $(document).on('mase:previewUpdated', function(e, data) {
                logEvent('EVENT', 'mase:previewUpdated - ' + JSON.stringify(data));
            });
            
            $(document).on('mase:settingsSaved', function(e, data) {
                logEvent('EVENT', 'mase:settingsSaved');
            });
            
            $(document).on('mase:settingsLoaded', function(e, data) {
                logEvent('EVENT', 'mase:settingsLoaded');
            });
            
            // Button handlers
            $('#run-all-tests').click(function() {
                runAllTests();
            });
            
            $('#toggle-preview').click(function() {
                MASE.livePreview.toggle();
            });
            
            $('#toggle-dark-mode').click(function() {
                MASE.darkModeToggle.toggle();
            });
            
            $('#save-settings').click(function() {
                MASE.settings.save();
            });
            
            $('#clear-log').click(function() {
                $('#event-log').empty();
                logEvent('SYSTEM', 'Event log cleared');
            });
            
            $('#clear-storage').click(function() {
                localStorage.removeItem(MASE.darkModeToggle.config.storageKey);
                logEvent('SYSTEM', 'localStorage cleared');
                updateStatus();
            });
        });
    </script>
</body>
</html>
