<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dark Mode Live Preview Integration Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
            transition: background-color 0.3s, color 0.3s;
        }
        
        body.mase-dark-mode {
            background-color: #1a1a1a;
            color: #e0e0e0;
        }
        
        .test-section {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        body.mase-dark-mode .test-section {
            background: #2d2d2d;
            border-color: #444;
        }
        
        h1, h2 {
            color: #333;
        }
        
        body.mase-dark-mode h1,
        body.mase-dark-mode h2 {
            color: #e0e0e0;
        }
        
        .test-result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-family: monospace;
        }
        
        .test-result.pass {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        
        .test-result.fail {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        
        .test-result.info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
        
        body.mase-dark-mode .test-result.pass {
            background: #1e4620;
            border-color: #2d5f2f;
            color: #a8d5a8;
        }
        
        body.mase-dark-mode .test-result.fail {
            background: #4a1f1f;
            border-color: #5f2d2d;
            color: #f5a8a8;
        }
        
        body.mase-dark-mode .test-result.info {
            background: #1f3a4a;
            border-color: #2d4f5f;
            color: #a8d5f5;
        }
        
        button {
            background: #0073aa;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        
        button:hover {
            background: #005a87;
        }
        
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .controls {
            margin: 20px 0;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-indicator.active {
            background: #28a745;
        }
        
        .status-indicator.inactive {
            background: #dc3545;
        }
        
        .event-log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        
        body.mase-dark-mode .event-log {
            background: #1a1a1a;
            border-color: #444;
            color: #e0e0e0;
        }
        
        .event-entry {
            padding: 5px;
            border-bottom: 1px solid #dee2e6;
        }
        
        body.mase-dark-mode .event-entry {
            border-bottom-color: #444;
        }
        
        .event-entry:last-child {
            border-bottom: none;
        }
        
        .timestamp {
            color: #6c757d;
            margin-right: 10px;
        }
        
        body.mase-dark-mode .timestamp {
            color: #999;
        }
    </style>
</head>
<body>
    <h1>Dark Mode Live Preview Integration Test</h1>
    <p>Tests the integration between dark mode toggle and live preview system.</p>
    
    <div class="test-section">
        <h2>Test Controls</h2>
        <div class="controls">
            <button id="toggle-preview">Toggle Live Preview</button>
            <button id="toggle-dark-mode">Toggle Dark Mode</button>
            <button id="run-tests">Run All Tests</button>
            <button id="clear-log">Clear Event Log</button>
        </div>
        
        <div style="margin-top: 15px;">
            <strong>Preview Status:</strong> 
            <span class="status-indicator" id="preview-indicator"></span>
            <span id="preview-status">Inactive</span>
        </div>
        
        <div style="margin-top: 10px;">
            <strong>Dark Mode:</strong> 
            <span class="status-indicator" id="dark-mode-indicator"></span>
            <span id="dark-mode-status">Light</span>
        </div>
    </div>
    
    <div class="test-section">
        <h2>Event Log</h2>
        <div class="event-log" id="event-log"></div>
    </div>
    
    <div class="test-section">
        <h2>Test Results</h2>
        <div id="test-results"></div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        // Mock MASE object with dark mode and live preview modules
        var MASE = {
            config: {
                nonce: 'test-nonce'
            },
            state: {
                livePreviewEnabled: false
            },
            darkModeToggle: {
                config: {
                    bodyClass: 'mase-dark-mode',
                    storageKey: 'mase_dark_mode',
                    transitionDuration: 300
                },
                state: {
                    currentMode: 'light',
                    isTransitioning: false,
                    systemPreference: 'light',
                    userPreference: null,
                    needsSync: false,
                    retryCount: 0,
                    maxRetries: 3
                },
                init: function() {
                    this.loadSavedPreference();
                    this.applyMode(this.state.currentMode, false);
                    updateStatus();
                },
                loadSavedPreference: function() {
                    try {
                        var mode = localStorage.getItem(this.config.storageKey);
                        if (mode) {
                            this.state.currentMode = mode;
                            this.state.userPreference = mode;
                        }
                    } catch (e) {
                        console.warn('localStorage unavailable');
                    }
                },
                setMode: function(mode) {
                    var self = this;
                    
                    if (mode !== 'light' && mode !== 'dark') {
                        logEvent('ERROR', 'Invalid mode: ' + mode);
                        return;
                    }
                    
                    if (self.state.isTransitioning) {
                        logEvent('WARN', 'Mode transition already in progress');
                        return;
                    }
                    
                    // Check if live preview is active (Requirement 7.1, 7.2)
                    if (MASE.livePreview && MASE.livePreview.isActive()) {
                        logEvent('INFO', 'Preview active, applying temporary dark mode change');
                        MASE.livePreview.updateDarkMode(mode);
                        return; // Don't save during preview (Requirement 7.6)
                    }
                    
                    self.state.isTransitioning = true;
                    self.state.currentMode = mode;
                    self.state.userPreference = mode;
                    
                    self.applyMode(mode, true);
                    self.savePreference(mode);
                    
                    $(document).trigger('mase:modeChanged', { mode: mode });
                    
                    setTimeout(function() {
                        self.state.isTransitioning = false;
                        $(document).trigger('mase:transitionComplete', { mode: mode });
                    }, self.config.transitionDuration);
                },
                toggle: function() {
                    var newMode = this.state.currentMode === 'light' ? 'dark' : 'light';
                    this.setMode(newMode);
                },
                applyMode: function(mode, animate) {
                    var $body = $('body');
                    
                    if (animate) {
                        $body.addClass('mase-transitioning');
                    }
                    
                    if (mode === 'dark') {
                        $body.addClass(this.config.bodyClass);
                    } else {
                        $body.removeClass(this.config.bodyClass);
                    }
                    
                    if (animate) {
                        setTimeout(function() {
                            $body.removeClass('mase-transitioning');
                        }, this.config.transitionDuration);
                    }
                    
                    updateStatus();
                    logEvent('MODE', 'Applied mode: ' + mode);
                },
                savePreference: function(mode) {
                    try {
                        localStorage.setItem(this.config.storageKey, mode);
                        logEvent('SAVE', 'Saved to localStorage: ' + mode);
                    } catch (e) {
                        logEvent('ERROR', 'Failed to save to localStorage');
                    }
                },
                updateIcon: function() {
                    logEvent('UI', 'Updated FAB icon for mode: ' + this.state.currentMode);
                }
            },
            livePreview: {
                previewState: {
                    savedDarkMode: null,
                    isPreviewActive: false
                },
                isActive: function() {
                    return this.previewState.isPreviewActive;
                },
                toggle: function() {
                    var self = MASE;
                    self.state.livePreviewEnabled = !self.state.livePreviewEnabled;
                    
                    if (self.state.livePreviewEnabled) {
                        // Entering preview mode
                        this.previewState.isPreviewActive = true;
                        this.previewState.savedDarkMode = self.darkModeToggle.state.currentMode;
                        logEvent('PREVIEW', 'Entering preview mode, saved dark mode: ' + this.previewState.savedDarkMode);
                    } else {
                        // Exiting preview mode
                        if (this.previewState.savedDarkMode !== null) {
                            logEvent('PREVIEW', 'Exiting preview mode, restoring dark mode: ' + this.previewState.savedDarkMode);
                            self.darkModeToggle.applyMode(this.previewState.savedDarkMode, false);
                            self.darkModeToggle.state.currentMode = this.previewState.savedDarkMode;
                            self.darkModeToggle.updateIcon();
                        }
                        
                        this.previewState.isPreviewActive = false;
                        this.previewState.savedDarkMode = null;
                    }
                    
                    updateStatus();
                },
                updateDarkMode: function(mode) {
                    var self = MASE;
                    
                    logEvent('PREVIEW', 'Updating dark mode in preview: ' + mode);
                    
                    self.darkModeToggle.applyMode(mode, true);
                    self.darkModeToggle.state.currentMode = mode;
                    self.darkModeToggle.updateIcon();
                    
                    $(document).trigger('mase:previewUpdated', { 
                        darkMode: mode,
                        isPreview: true 
                    });
                    
                    logEvent('PREVIEW', 'Dark mode preview applied (not saved)');
                }
            }
        };
        
        // Event logging
        function logEvent(type, message) {
            var timestamp = new Date().toLocaleTimeString();
            var entry = $('<div class="event-entry"></div>');
            entry.html('<span class="timestamp">' + timestamp + '</span><strong>[' + type + ']</strong> ' + message);
            $('#event-log').prepend(entry);
        }
        
        // Update status indicators
        function updateStatus() {
            var previewActive = MASE.livePreview.isActive();
            var darkMode = MASE.darkModeToggle.state.currentMode;
            
            $('#preview-indicator').toggleClass('active', previewActive).toggleClass('inactive', !previewActive);
            $('#preview-status').text(previewActive ? 'Active' : 'Inactive');
            
            $('#dark-mode-indicator').toggleClass('active', darkMode === 'dark').toggleClass('inactive', darkMode === 'light');
            $('#dark-mode-status').text(darkMode === 'dark' ? 'Dark' : 'Light');
        }
        
        // Test functions
        function addTestResult(name, passed, message) {
            var result = $('<div class="test-result"></div>');
            result.addClass(passed ? 'pass' : 'fail');
            result.html('<strong>' + (passed ? '✓ PASS' : '✗ FAIL') + ':</strong> ' + name + (message ? '<br>' + message : ''));
            $('#test-results').append(result);
        }
        
        function addTestInfo(message) {
            var result = $('<div class="test-result info"></div>');
            result.html('<strong>ℹ INFO:</strong> ' + message);
            $('#test-results').append(result);
        }
        
        // Test suite
        async function runTests() {
            $('#test-results').empty();
            addTestInfo('Starting test suite...');
            
            // Test 1: Dark mode toggle works when preview is inactive
            addTestInfo('Test 1: Dark mode toggle without preview');
            var initialMode = MASE.darkModeToggle.state.currentMode;
            MASE.darkModeToggle.toggle();
            await sleep(400);
            var newMode = MASE.darkModeToggle.state.currentMode;
            addTestResult(
                'Dark mode toggles when preview inactive',
                newMode !== initialMode,
                'Initial: ' + initialMode + ', After toggle: ' + newMode
            );
            
            // Test 2: Preview saves dark mode state
            addTestInfo('Test 2: Preview saves dark mode state');
            var modeBeforePreview = MASE.darkModeToggle.state.currentMode;
            MASE.livePreview.toggle(); // Enter preview
            var savedMode = MASE.livePreview.previewState.savedDarkMode;
            addTestResult(
                'Preview saves current dark mode',
                savedMode === modeBeforePreview,
                'Mode before preview: ' + modeBeforePreview + ', Saved mode: ' + savedMode
            );
            
            // Test 3: Dark mode changes are temporary during preview
            addTestInfo('Test 3: Temporary dark mode changes in preview');
            var modeInPreview = MASE.darkModeToggle.state.currentMode;
            MASE.darkModeToggle.toggle(); // Toggle in preview
            await sleep(400);
            var modeAfterToggle = MASE.darkModeToggle.state.currentMode;
            
            // Check localStorage wasn't updated
            var storedMode = localStorage.getItem(MASE.darkModeToggle.config.storageKey);
            addTestResult(
                'Dark mode changes are temporary in preview',
                modeAfterToggle !== modeInPreview && storedMode === savedMode,
                'Mode changed visually but not saved to localStorage'
            );
            
            // Test 4: Preview restores saved mode on exit
            addTestInfo('Test 4: Preview restores saved mode');
            MASE.livePreview.toggle(); // Exit preview
            await sleep(100);
            var restoredMode = MASE.darkModeToggle.state.currentMode;
            addTestResult(
                'Preview restores saved dark mode on exit',
                restoredMode === savedMode,
                'Saved mode: ' + savedMode + ', Restored mode: ' + restoredMode
            );
            
            // Test 5: Events are triggered correctly
            addTestInfo('Test 5: Event triggering');
            var modeChangedFired = false;
            var previewUpdatedFired = false;
            
            $(document).one('mase:modeChanged', function() {
                modeChangedFired = true;
            });
            
            $(document).one('mase:previewUpdated', function() {
                previewUpdatedFired = true;
            });
            
            // Enter preview and toggle
            MASE.livePreview.toggle();
            MASE.darkModeToggle.toggle();
            await sleep(400);
            
            addTestResult(
                'mase:previewUpdated event fires during preview',
                previewUpdatedFired,
                'Event fired: ' + previewUpdatedFired
            );
            
            // Exit preview and toggle normally
            MASE.livePreview.toggle();
            MASE.darkModeToggle.toggle();
            await sleep(400);
            
            addTestResult(
                'mase:modeChanged event fires outside preview',
                modeChangedFired,
                'Event fired: ' + modeChangedFired
            );
            
            // Test 6: isActive() method works
            addTestInfo('Test 6: isActive() method');
            MASE.livePreview.toggle();
            var activeWhenOn = MASE.livePreview.isActive();
            MASE.livePreview.toggle();
            var activeWhenOff = MASE.livePreview.isActive();
            addTestResult(
                'isActive() correctly reports preview state',
                activeWhenOn === true && activeWhenOff === false,
                'Active when on: ' + activeWhenOn + ', Active when off: ' + activeWhenOff
            );
            
            addTestInfo('Test suite complete!');
        }
        
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
        
        // Event listeners
        $(document).ready(function() {
            // Initialize
            MASE.darkModeToggle.init();
            updateStatus();
            logEvent('INIT', 'System initialized');
            
            // Listen for custom events
            $(document).on('mase:modeChanged', function(e, data) {
                logEvent('EVENT', 'mase:modeChanged - mode: ' + data.mode);
            });
            
            $(document).on('mase:transitionComplete', function(e, data) {
                logEvent('EVENT', 'mase:transitionComplete - mode: ' + data.mode);
            });
            
            $(document).on('mase:previewUpdated', function(e, data) {
                logEvent('EVENT', 'mase:previewUpdated - ' + JSON.stringify(data));
            });
            
            // Button handlers
            $('#toggle-preview').click(function() {
                MASE.livePreview.toggle();
            });
            
            $('#toggle-dark-mode').click(function() {
                MASE.darkModeToggle.toggle();
            });
            
            $('#run-tests').click(function() {
                runTests();
            });
            
            $('#clear-log').click(function() {
                $('#event-log').empty();
                logEvent('SYSTEM', 'Event log cleared');
            });
        });
    </script>
</body>
</html>
