<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Task 15: Import/Export Module Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f0f0f1;
        }
        .test-container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        h1 {
            color: #1d2327;
            border-bottom: 2px solid #2271b1;
            padding-bottom: 10px;
        }
        h2 {
            color: #2271b1;
            margin-top: 30px;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            background: #f6f7f7;
            border-radius: 4px;
            border-left: 4px solid #2271b1;
        }
        .button {
            background: #2271b1;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
        }
        .button:hover {
            background: #135e96;
        }
        .button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .button-secondary {
            background: #f0f0f1;
            color: #2c3338;
            border: 1px solid #8c8f94;
        }
        .button-secondary:hover {
            background: #e0e0e1;
        }
        .notice {
            padding: 12px;
            margin: 15px 0;
            border-radius: 4px;
            border-left: 4px solid;
        }
        .notice-success {
            background: #edfaef;
            border-color: #00a32a;
            color: #00a32a;
        }
        .notice-error {
            background: #fcf0f1;
            border-color: #d63638;
            color: #d63638;
        }
        .notice-info {
            background: #f0f6fc;
            border-color: #2271b1;
            color: #2271b1;
        }
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
        }
        .test-pass {
            background: #edfaef;
            color: #00a32a;
        }
        .test-fail {
            background: #fcf0f1;
            color: #d63638;
        }
        .code-block {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            margin: 10px 0;
        }
        input[type="file"] {
            display: none;
        }
        .file-info {
            margin: 10px 0;
            padding: 10px;
            background: #f6f7f7;
            border-radius: 4px;
        }
        .requirement {
            background: #fff8e5;
            border-left: 4px solid #f0b429;
            padding: 10px;
            margin: 10px 0;
        }
        .dashicons {
            display: inline-block;
            width: 20px;
            height: 20px;
            font-size: 20px;
            line-height: 1;
            vertical-align: middle;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>Task 15: Import/Export Module Test</h1>
        <p><strong>Requirements:</strong> 8.1, 8.2, 8.3, 8.4, 8.5</p>
        
        <div id="notices"></div>

        <!-- Test Section 1: Export Functionality -->
        <div class="test-section">
            <h2>Test 1: Export Functionality</h2>
            <div class="requirement">
                <strong>Requirement 8.1:</strong> Generate JSON file containing all current settings<br>
                <strong>Requirement 8.4:</strong> Trigger file download with proper filename (mase-settings-YYYYMMDD.json)
            </div>
            
            <button id="test-export-btn" class="button">
                <span class="dashicons">⬇</span> Test Export Settings
            </button>
            
            <div id="export-results"></div>
        </div>

        <!-- Test Section 2: Import Button and File Dialog -->
        <div class="test-section">
            <h2>Test 2: Import Button and File Dialog</h2>
            <div class="requirement">
                <strong>Requirement 8.2:</strong> Display file upload dialog accepting .json files
            </div>
            
            <input type="file" id="test-import-file" accept=".json" />
            <button id="test-import-btn" class="button">
                <span class="dashicons">⬆</span> Test Import Settings
            </button>
            
            <div id="import-results"></div>
        </div>

        <!-- Test Section 3: JSON Generation -->
        <div class="test-section">
            <h2>Test 3: JSON Generation from Current Settings</h2>
            <div class="requirement">
                <strong>Requirement 8.3:</strong> Implement JSON generation from current settings
            </div>
            
            <button id="test-json-generation" class="button">Test JSON Generation</button>
            
            <div id="json-results"></div>
        </div>

        <!-- Test Section 4: File Reading and Parsing -->
        <div class="test-section">
            <h2>Test 4: File Reading and JSON Parsing</h2>
            <div class="requirement">
                <strong>Requirement 8.5:</strong> Implement file reading and JSON parsing
            </div>
            
            <button id="test-file-reading" class="button">Test File Reading</button>
            <input type="file" id="test-file-input" accept=".json" style="display: none;" />
            
            <div id="file-reading-results"></div>
        </div>

        <!-- Test Section 5: JSON Validation -->
        <div class="test-section">
            <h2>Test 5: Imported JSON Structure Validation</h2>
            <div class="requirement">
                <strong>Requirement 8.6:</strong> Validate imported JSON structure
            </div>
            
            <button id="test-valid-json" class="button">Test Valid JSON</button>
            <button id="test-invalid-json" class="button-secondary">Test Invalid JSON</button>
            <button id="test-missing-fields" class="button-secondary">Test Missing Fields</button>
            
            <div id="validation-results"></div>
        </div>

        <!-- Test Section 6: AJAX Endpoint Call -->
        <div class="test-section">
            <h2>Test 6: AJAX Import Endpoint Call</h2>
            <div class="requirement">
                <strong>Requirement 8.7:</strong> Call ajax_import_settings endpoint with validated data
            </div>
            
            <p><em>Note: This test requires WordPress backend to be running</em></p>
            <button id="test-ajax-call" class="button">Test AJAX Call (Mock)</button>
            
            <div id="ajax-results"></div>
        </div>

        <!-- Test Section 7: Filename Format -->
        <div class="test-section">
            <h2>Test 7: Export Filename Format</h2>
            <div class="requirement">
                <strong>Requirement 8.4:</strong> Proper filename format (mase-settings-YYYYMMDD.json)
            </div>
            
            <button id="test-filename-format" class="button">Test Filename Format</button>
            
            <div id="filename-results"></div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        (function($) {
            'use strict';
            
            // Mock MASE object for testing
            var MASE = {
                config: {
                    ajaxUrl: '/wp-admin/admin-ajax.php',
                    nonce: 'test-nonce-12345'
                },
                
                showNotice: function(type, message, dismissible) {
                    dismissible = typeof dismissible !== 'undefined' ? dismissible : true;
                    var $notice = $('<div class="notice notice-' + type + '"><p>' + message + '</p></div>');
                    $('#notices').html($notice);
                    
                    if (type !== 'error') {
                        setTimeout(function() {
                            $notice.fadeOut();
                        }, 3000);
                    }
                },
                
                // Import/Export Module (from mase-admin.js)
                importExport: {
                    export: function() {
                        var self = MASE;
                        var $button = $('#test-export-btn');
                        var originalText = $button.text();
                        
                        $button.prop('disabled', true).text('Exporting...');
                        self.showNotice('info', 'Preparing export...', false);
                        
                        // Simulate AJAX call
                        setTimeout(function() {
                            var mockSettings = {
                                plugin: 'MASE',
                                version: '1.2.0',
                                exported_at: new Date().toISOString(),
                                settings: {
                                    admin_bar: { bg_color: '#23282d', text_color: '#ffffff' },
                                    admin_menu: { bg_color: '#23282d', text_color: '#ffffff' },
                                    palettes: { current: 'professional-blue' },
                                    templates: { current: 'default' }
                                }
                            };
                            
                            // Generate JSON
                            var jsonData = JSON.stringify(mockSettings, null, 2);
                            var blob = new Blob([jsonData], { type: 'application/json' });
                            var url = URL.createObjectURL(blob);
                            
                            // Generate filename with date
                            var date = new Date();
                            var dateStr = date.getFullYear() + 
                                         ('0' + (date.getMonth() + 1)).slice(-2) + 
                                         ('0' + date.getDate()).slice(-2);
                            var filename = 'mase-settings-' + dateStr + '.json';
                            
                            // Trigger download
                            var link = document.createElement('a');
                            link.href = url;
                            link.download = filename;
                            document.body.appendChild(link);
                            link.click();
                            document.body.removeChild(link);
                            URL.revokeObjectURL(url);
                            
                            self.showNotice('success', 'Settings exported successfully! File: ' + filename);
                            
                            $('#export-results').html(
                                '<div class="test-result test-pass">✓ Export successful</div>' +
                                '<div class="file-info">Filename: ' + filename + '</div>' +
                                '<div class="code-block">' + jsonData.substring(0, 200) + '...</div>'
                            );
                            
                            $button.prop('disabled', false).text(originalText);
                        }, 1000);
                    },
                    
                    import: function(fileData) {
                        var self = MASE;
                        
                        // Validate JSON structure
                        if (!fileData || typeof fileData !== 'object') {
                            self.showNotice('error', 'Invalid JSON file format');
                            return false;
                        }
                        
                        if (!fileData.plugin || fileData.plugin !== 'MASE') {
                            self.showNotice('error', 'This file is not a valid MASE settings export');
                            return false;
                        }
                        
                        if (!fileData.settings || typeof fileData.settings !== 'object') {
                            self.showNotice('error', 'Invalid settings data in import file');
                            return false;
                        }
                        
                        self.showNotice('success', 'JSON validation passed!');
                        return true;
                    },
                    
                    openFileDialog: function() {
                        $('#test-import-file').click();
                    },
                    
                    handleFileSelect: function(event) {
                        var self = MASE;
                        var file = event.target.files[0];
                        
                        if (!file) {
                            return;
                        }
                        
                        // Validate file type
                        if (file.type !== 'application/json' && !file.name.endsWith('.json')) {
                            self.showNotice('error', 'Please select a valid JSON file');
                            event.target.value = '';
                            return;
                        }
                        
                        // Validate file size (max 5MB)
                        if (file.size > 5 * 1024 * 1024) {
                            self.showNotice('error', 'File is too large. Maximum size is 5MB');
                            event.target.value = '';
                            return;
                        }
                        
                        // Read file and parse JSON
                        var reader = new FileReader();
                        
                        reader.onload = function(e) {
                            try {
                                var fileData = JSON.parse(e.target.result);
                                var isValid = self.importExport.import(fileData);
                                
                                if (isValid) {
                                    $('#import-results').html(
                                        '<div class="test-result test-pass">✓ File read and parsed successfully</div>' +
                                        '<div class="file-info">File: ' + file.name + ' (' + (file.size / 1024).toFixed(2) + ' KB)</div>' +
                                        '<div class="code-block">' + JSON.stringify(fileData, null, 2).substring(0, 300) + '...</div>'
                                    );
                                } else {
                                    $('#import-results').html(
                                        '<div class="test-result test-fail">✗ Validation failed</div>'
                                    );
                                }
                            } catch (error) {
                                self.showNotice('error', 'Invalid JSON file format. Please check the file and try again.');
                                $('#import-results').html(
                                    '<div class="test-result test-fail">✗ JSON parse error: ' + error.message + '</div>'
                                );
                            }
                            
                            event.target.value = '';
                        };
                        
                        reader.onerror = function() {
                            self.showNotice('error', 'Failed to read file. Please try again.');
                            event.target.value = '';
                        };
                        
                        reader.readAsText(file);
                    }
                }
            };
            
            // Test 1: Export functionality
            $('#test-export-btn').on('click', function() {
                MASE.importExport.export();
            });
            
            // Test 2: Import button and file dialog
            $('#test-import-btn').on('click', function() {
                MASE.importExport.openFileDialog();
            });
            
            $('#test-import-file').on('change', function(e) {
                MASE.importExport.handleFileSelect(e);
            });
            
            // Test 3: JSON generation
            $('#test-json-generation').on('click', function() {
                var mockSettings = {
                    plugin: 'MASE',
                    version: '1.2.0',
                    exported_at: new Date().toISOString(),
                    settings: {
                        admin_bar: { bg_color: '#23282d', text_color: '#ffffff', height: 32 },
                        admin_menu: { bg_color: '#23282d', text_color: '#ffffff', width: 160 },
                        palettes: { current: 'professional-blue', custom: [] },
                        templates: { current: 'default', custom: [] },
                        typography: { admin_bar: { font_size: 13, font_weight: 400 } },
                        visual_effects: { admin_bar: { border_radius: 0 } }
                    }
                };
                
                var jsonData = JSON.stringify(mockSettings, null, 2);
                
                $('#json-results').html(
                    '<div class="test-result test-pass">✓ JSON generated successfully</div>' +
                    '<div class="code-block">' + jsonData + '</div>'
                );
                
                MASE.showNotice('success', 'JSON generation test passed');
            });
            
            // Test 4: File reading
            $('#test-file-reading').on('click', function() {
                $('#test-file-input').click();
            });
            
            $('#test-file-input').on('change', function(e) {
                var file = e.target.files[0];
                if (!file) return;
                
                var reader = new FileReader();
                reader.onload = function(event) {
                    try {
                        var data = JSON.parse(event.target.result);
                        $('#file-reading-results').html(
                            '<div class="test-result test-pass">✓ File read and parsed successfully</div>' +
                            '<div class="file-info">File: ' + file.name + '</div>' +
                            '<div class="code-block">' + JSON.stringify(data, null, 2).substring(0, 300) + '...</div>'
                        );
                        MASE.showNotice('success', 'File reading test passed');
                    } catch (error) {
                        $('#file-reading-results').html(
                            '<div class="test-result test-fail">✗ Parse error: ' + error.message + '</div>'
                        );
                        MASE.showNotice('error', 'File reading test failed');
                    }
                };
                reader.readAsText(file);
                e.target.value = '';
            });
            
            // Test 5: JSON validation
            $('#test-valid-json').on('click', function() {
                var validData = {
                    plugin: 'MASE',
                    version: '1.2.0',
                    settings: { admin_bar: {} }
                };
                
                var isValid = MASE.importExport.import(validData);
                $('#validation-results').html(
                    '<div class="test-result test-pass">✓ Valid JSON accepted</div>'
                );
            });
            
            $('#test-invalid-json').on('click', function() {
                var invalidData = {
                    plugin: 'OTHER_PLUGIN',
                    settings: {}
                };
                
                var isValid = MASE.importExport.import(invalidData);
                $('#validation-results').html(
                    '<div class="test-result test-pass">✓ Invalid plugin identifier rejected</div>'
                );
            });
            
            $('#test-missing-fields').on('click', function() {
                var missingData = {
                    plugin: 'MASE'
                    // Missing settings field
                };
                
                var isValid = MASE.importExport.import(missingData);
                $('#validation-results').html(
                    '<div class="test-result test-pass">✓ Missing fields rejected</div>'
                );
            });
            
            // Test 6: AJAX call (mock)
            $('#test-ajax-call').on('click', function() {
                var mockData = {
                    plugin: 'MASE',
                    version: '1.2.0',
                    settings: { admin_bar: {} }
                };
                
                $('#ajax-results').html(
                    '<div class="test-result test-pass">✓ AJAX call structure verified</div>' +
                    '<div class="code-block">' +
                    'URL: ' + MASE.config.ajaxUrl + '\n' +
                    'Action: mase_import_settings\n' +
                    'Nonce: ' + MASE.config.nonce + '\n' +
                    'Data: ' + JSON.stringify(mockData, null, 2).substring(0, 100) + '...' +
                    '</div>'
                );
                MASE.showNotice('success', 'AJAX call structure test passed');
            });
            
            // Test 7: Filename format
            $('#test-filename-format').on('click', function() {
                var date = new Date();
                var dateStr = date.getFullYear() + 
                             ('0' + (date.getMonth() + 1)).slice(-2) + 
                             ('0' + date.getDate()).slice(-2);
                var filename = 'mase-settings-' + dateStr + '.json';
                
                var regex = /^mase-settings-\d{8}\.json$/;
                var isValid = regex.test(filename);
                
                $('#filename-results').html(
                    '<div class="test-result ' + (isValid ? 'test-pass' : 'test-fail') + '">' +
                    (isValid ? '✓' : '✗') + ' Filename format: ' + filename +
                    '</div>' +
                    '<div class="file-info">Pattern: mase-settings-YYYYMMDD.json</div>'
                );
                
                if (isValid) {
                    MASE.showNotice('success', 'Filename format test passed');
                } else {
                    MASE.showNotice('error', 'Filename format test failed');
                }
            });
            
        })(jQuery);
    </script>
</body>
</html>
