<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Task 3: Template Apply Handler Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen-Sans, Ubuntu, Cantarell, "Helvetica Neue", sans-serif;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .test-section {
            margin-bottom: 40px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .mase-template-card {
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 20px;
            margin-bottom: 20px;
            transition: opacity 0.3s;
        }
        
        .mase-template-card h3 {
            margin-top: 0;
        }
        
        .mase-template-apply-btn {
            background: #0073aa;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 3px;
            cursor: pointer;
        }
        
        .mase-template-apply-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .mase-notice {
            padding: 12px;
            margin: 10px 0;
            border-radius: 4px;
            border-left: 4px solid;
        }
        
        .mase-notice-success {
            background: #d4edda;
            border-color: #28a745;
            color: #155724;
        }
        
        .mase-notice-error {
            background: #f8d7da;
            border-color: #dc3545;
            color: #721c24;
        }
        
        .mase-notice-info {
            background: #d1ecf1;
            border-color: #17a2b8;
            color: #0c5460;
        }
        
        #console-log {
            background: #f5f5f5;
            border: 1px solid #ddd;
            padding: 10px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        
        .log-entry {
            margin: 2px 0;
            padding: 2px 4px;
        }
        
        .log-info {
            color: #0073aa;
        }
        
        .log-error {
            color: #dc3545;
        }
        
        .log-success {
            color: #28a745;
        }
    </style>
</head>
<body>
    <h1>Task 3: Template Apply Handler Test</h1>
    <p>This test verifies the JavaScript implementation for the template Apply button handler.</p>
    
    <div class="test-section">
        <h2>Test 1: Basic Apply Button Click</h2>
        <p>Click the Apply button below. You should see:</p>
        <ul>
            <li>A confirmation dialog with template details</li>
            <li>Button changes to "Applying..." and becomes disabled</li>
            <li>Card opacity reduces to 0.6</li>
            <li>Console logs showing the process</li>
        </ul>
        
        <div class="mase-template-card" data-template="professional-blue" data-template-id="professional-blue">
            <h3>Professional Blue</h3>
            <p>A clean, professional design with blue accents.</p>
            <button type="button" class="mase-template-apply-btn" data-template-id="professional-blue">Apply</button>
        </div>
    </div>
    
    <div class="test-section">
        <h2>Test 2: Missing Template ID</h2>
        <p>This card has no data-template attribute. Clicking Apply should log an error.</p>
        
        <div class="mase-template-card">
            <h3>Invalid Template</h3>
            <p>This template card is missing the data-template attribute.</p>
            <button type="button" class="mase-template-apply-btn">Apply</button>
        </div>
    </div>
    
    <div class="test-section">
        <h2>Test 3: Multiple Templates</h2>
        <p>Test with multiple template cards to ensure event delegation works correctly.</p>
        
        <div class="mase-template-card" data-template="modern-dark" data-template-id="modern-dark">
            <h3>Modern Dark</h3>
            <p>A sleek dark theme for modern interfaces.</p>
            <button type="button" class="mase-template-apply-btn" data-template-id="modern-dark">Apply</button>
        </div>
        
        <div class="mase-template-card" data-template="minimal-light" data-template-id="minimal-light">
            <h3>Minimal Light</h3>
            <p>A clean, minimal light theme.</p>
            <button type="button" class="mase-template-apply-btn" data-template-id="minimal-light">Apply</button>
        </div>
    </div>
    
    <div class="test-section">
        <h2>Console Log Output</h2>
        <div id="console-log"></div>
        <button onclick="clearConsoleLog()">Clear Log</button>
    </div>
    
    <input type="hidden" id="mase_nonce" value="test-nonce-12345" />
    
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        // Mock MASE object with minimal implementation for testing
        var MASE = {
            config: {
                ajaxUrl: '/wp-admin/admin-ajax.php',
                nonce: 'test-nonce-12345'
            },
            
            state: {
                currentTemplate: null,
                isDirty: false
            },
            
            templateManager: {
                handleTemplateApply: function(e) {
                    var self = MASE;
                    
                    // Subtask 3.1: Prevent default event and stop propagation
                    e.preventDefault();
                    e.stopPropagation();
                    
                    // Get button element and parent card
                    var $button = $(e.currentTarget);
                    var $card = $button.closest('.mase-template-card');
                    
                    // Read data-template attribute from card
                    var templateId = $card.attr('data-template');
                    
                    // Validate template ID exists
                    if (!templateId) {
                        logToConsole('ERROR: Template ID not found on card', 'error');
                        return;
                    }
                    
                    // Get template name from card for confirmation
                    var templateName = $card.find('h3').text();
                    
                    // Log template apply action to console
                    logToConsole('Apply button clicked for template: ' + templateId, 'info');
                    
                    // Subtask 3.2: Implement confirmation dialog
                    var confirmMessage = 'Apply "' + templateName + '" template?\n\n' +
                        'This will overwrite your current settings including:\n' +
                        '• Color scheme\n' +
                        '• Typography\n' +
                        '• Visual effects\n\n' +
                        'This action cannot be undone.';
                    
                    if (!confirm(confirmMessage)) {
                        logToConsole('User cancelled template application', 'info');
                        return;
                    }
                    
                    // Subtask 3.3: Implement loading state
                    $button.prop('disabled', true).text('Applying...');
                    $card.css('opacity', '0.6');
                    
                    var originalText = 'Apply';
                    
                    // Subtask 3.4: Implement AJAX request (mocked for testing)
                    var requestData = {
                        action: 'mase_apply_template',
                        nonce: $('#mase_nonce').val(),
                        template_id: templateId
                    };
                    
                    logToConsole('Sending AJAX request: ' + JSON.stringify(requestData), 'info');
                    
                    // Mock AJAX call with timeout
                    setTimeout(function() {
                        // Simulate success response
                        var mockSuccess = Math.random() > 0.3; // 70% success rate
                        
                        if (mockSuccess) {
                            // Subtask 3.5: Implement success handler
                            logToConsole('AJAX response - Success', 'success');
                            self.showNotice('success', 'Template "' + templateName + '" applied successfully!');
                            
                            logToConsole('Page would reload in 1 second (disabled for testing)', 'info');
                            
                            // In real implementation, page would reload:
                            // setTimeout(function() { location.reload(); }, 1000);
                            
                            // For testing, restore button after 2 seconds
                            setTimeout(function() {
                                $button.prop('disabled', false).text(originalText);
                                $card.css('opacity', '1');
                            }, 2000);
                        } else {
                            // Subtask 3.6: Implement error handler
                            var errorMessage = 'Failed to apply template. Please try again.';
                            logToConsole('AJAX error: ' + errorMessage, 'error');
                            
                            self.showNotice('error', errorMessage);
                            
                            // Restore button state
                            $button.prop('disabled', false).text(originalText);
                            $card.css('opacity', '1');
                        }
                    }, 1500); // Simulate network delay
                },
                
                updateActiveBadge: function(templateId) {
                    logToConsole('Updating active badge for template: ' + templateId, 'info');
                }
            },
            
            showNotice: function(type, message) {
                logToConsole('Showing notice (' + type + '): ' + message, type === 'error' ? 'error' : 'success');
                
                var $notice = $('<div>')
                    .addClass('mase-notice')
                    .addClass('mase-notice-' + type)
                    .text(message);
                
                $('.mase-notice').remove();
                $('body').prepend($notice);
                
                if (type === 'success') {
                    setTimeout(function() {
                        $notice.fadeOut(300, function() {
                            $(this).remove();
                        });
                    }, 3000);
                }
            }
        };
        
        // Console logging function
        function logToConsole(message, type) {
            type = type || 'info';
            var $log = $('#console-log');
            var timestamp = new Date().toLocaleTimeString();
            var $entry = $('<div class="log-entry log-' + type + '">')
                .text('[' + timestamp + '] ' + message);
            $log.append($entry);
            $log.scrollTop($log[0].scrollHeight);
            
            // Also log to browser console
            console.log('MASE:', message);
        }
        
        function clearConsoleLog() {
            $('#console-log').empty();
        }
        
        // Subtask 3.7: Register event handler
        $(document).ready(function() {
            logToConsole('Initializing MASE Admin...', 'info');
            
            // Use delegated event for template apply buttons
            $(document).on('click', '.mase-template-apply-btn', MASE.templateManager.handleTemplateApply.bind(MASE));
            
            logToConsole('Event handlers registered successfully', 'success');
            logToConsole('Ready to test template apply functionality', 'info');
        });
    </script>
</body>
</html>
