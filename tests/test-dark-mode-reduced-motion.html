<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dark Mode Reduced Motion Test - MASE</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
            background-color: #f0f0f1;
        }
        
        .test-container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        h1 {
            color: #1e1e1e;
            margin-bottom: 10px;
        }
        
        .test-description {
            color: #646970;
            margin-bottom: 30px;
            line-height: 1.6;
        }
        
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 4px;
            border-left: 4px solid #0073aa;
        }
        
        .test-section h2 {
            margin-top: 0;
            color: #0073aa;
            font-size: 18px;
        }
        
        .test-result {
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
            font-family: monospace;
            font-size: 14px;
        }
        
        .test-result.pass {
            background: #e7f7ed;
            border: 1px solid #00a32a;
            color: #00a32a;
        }
        
        .test-result.fail {
            background: #fcf0f1;
            border: 1px solid #d63638;
            color: #d63638;
        }
        
        .test-result.info {
            background: #e5f5fa;
            border: 1px solid #0073aa;
            color: #0073aa;
        }
        
        .test-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin: 20px 0;
        }
        
        button {
            padding: 10px 20px;
            background: #0073aa;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
        }
        
        button:hover {
            background: #005a87;
        }
        
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-indicator.active {
            background: #00a32a;
        }
        
        .status-indicator.inactive {
            background: #d63638;
        }
        
        .instructions {
            background: #fff8e5;
            border: 1px solid #dba617;
            padding: 15px;
            border-radius: 4px;
            margin: 20px 0;
        }
        
        .instructions h3 {
            margin-top: 0;
            color: #dba617;
        }
        
        .instructions ol {
            margin: 10px 0;
            padding-left: 20px;
        }
        
        .instructions li {
            margin: 8px 0;
            line-height: 1.6;
        }
        
        code {
            background: #f0f0f1;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: monospace;
            font-size: 13px;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>🎭 Dark Mode Reduced Motion Test</h1>
        <p class="test-description">
            This test verifies that the dark mode toggle respects the user's reduced motion preference.
            When reduced motion is enabled, all animations and transitions should be disabled or minimized.
        </p>
        
        <div class="instructions">
            <h3>📋 Test Instructions</h3>
            <ol>
                <li><strong>Enable Reduced Motion:</strong>
                    <ul>
                        <li><strong>macOS:</strong> System Preferences → Accessibility → Display → Reduce motion</li>
                        <li><strong>Windows:</strong> Settings → Ease of Access → Display → Show animations</li>
                        <li><strong>Linux:</strong> Settings → Universal Access → Reduce animation</li>
                        <li><strong>Browser DevTools:</strong> Open DevTools → Rendering → Emulate CSS media feature prefers-reduced-motion: reduce</li>
                    </ul>
                </li>
                <li>Click "Run Tests" to check if reduced motion is detected</li>
                <li>Toggle dark mode and observe that transitions are instant (no smooth fade)</li>
                <li>Verify that the FAB icon changes instantly without rotation animation</li>
                <li>Disable reduced motion and verify animations work normally</li>
            </ol>
        </div>
        
        <div class="test-section">
            <h2>System Status</h2>
            <div id="system-status"></div>
        </div>
        
        <div class="test-section">
            <h2>Test Controls</h2>
            <div class="test-controls">
                <button id="run-tests">Run Tests</button>
                <button id="toggle-mode">Toggle Dark Mode</button>
                <button id="check-css">Check CSS Media Query</button>
                <button id="simulate-reduced-motion">Simulate Reduced Motion</button>
            </div>
        </div>
        
        <div class="test-section">
            <h2>Test Results</h2>
            <div id="test-results"></div>
        </div>
    </div>
    
    <script>
        // Mock MASE object for testing
        window.MASE = {
            config: {
                nonce: 'test-nonce'
            },
            darkModeToggle: {
                config: {
                    fabSelector: '.mase-dark-mode-fab',
                    bodyClass: 'mase-dark-mode',
                    storageKey: 'mase_dark_mode',
                    transitionDuration: 300,
                    keyboardShortcut: { ctrl: true, shift: true, key: 'D' }
                },
                state: {
                    currentMode: 'light',
                    isTransitioning: false,
                    systemPreference: null,
                    userPreference: null,
                    needsSync: false,
                    retryCount: 0,
                    maxRetries: 3,
                    prefersReducedMotion: false
                },
                
                detectReducedMotion: function() {
                    var self = this;
                    
                    if (!window.matchMedia) {
                        console.warn('MASE: matchMedia not supported');
                        self.state.prefersReducedMotion = false;
                        return false;
                    }
                    
                    try {
                        var reducedMotionQuery = window.matchMedia('(prefers-reduced-motion: reduce)');
                        
                        if (!reducedMotionQuery || typeof reducedMotionQuery.matches === 'undefined') {
                            console.warn('MASE: matchMedia query invalid for reduced motion');
                            self.state.prefersReducedMotion = false;
                            return false;
                        }
                        
                        self.state.prefersReducedMotion = reducedMotionQuery.matches;
                        
                        console.log('MASE: Reduced motion preference detected:', self.state.prefersReducedMotion, {
                            matches: reducedMotionQuery.matches,
                            media: reducedMotionQuery.media,
                            supported: true
                        });
                        
                        return self.state.prefersReducedMotion;
                    } catch (error) {
                        console.error('MASE: Reduced motion detection failed:', error);
                        self.state.prefersReducedMotion = false;
                        return false;
                    }
                },
                
                applyMode: function(mode, animate) {
                    var self = this;
                    var shouldAnimate = animate && !self.state.prefersReducedMotion;
                    
                    if (self.state.prefersReducedMotion && animate) {
                        console.log('MASE: Reduced motion preferred, disabling animations');
                    }
                    
                    if (shouldAnimate) {
                        document.body.classList.add('mase-transitioning');
                    }
                    
                    if (mode === 'dark') {
                        document.body.classList.add(self.config.bodyClass);
                    } else {
                        document.body.classList.remove(self.config.bodyClass);
                    }
                    
                    if (shouldAnimate) {
                        setTimeout(function() {
                            document.body.classList.remove('mase-transitioning');
                        }, self.config.transitionDuration);
                    }
                    
                    self.state.currentMode = mode;
                },
                
                toggle: function() {
                    var newMode = this.state.currentMode === 'light' ? 'dark' : 'light';
                    this.applyMode(newMode, true);
                }
            }
        };
        
        // Test functions
        function addResult(message, type) {
            const resultsDiv = document.getElementById('test-results');
            const resultDiv = document.createElement('div');
            resultDiv.className = `test-result ${type}`;
            resultDiv.textContent = message;
            resultsDiv.appendChild(resultDiv);
        }
        
        function clearResults() {
            document.getElementById('test-results').innerHTML = '';
        }
        
        function updateSystemStatus() {
            const statusDiv = document.getElementById('system-status');
            const prefersReducedMotion = MASE.darkModeToggle.state.prefersReducedMotion;
            const currentMode = MASE.darkModeToggle.state.currentMode;
            
            statusDiv.innerHTML = `
                <div style="margin: 10px 0;">
                    <span class="status-indicator ${prefersReducedMotion ? 'active' : 'inactive'}"></span>
                    <strong>Reduced Motion:</strong> ${prefersReducedMotion ? 'ENABLED' : 'DISABLED'}
                </div>
                <div style="margin: 10px 0;">
                    <span class="status-indicator ${currentMode === 'dark' ? 'active' : 'inactive'}"></span>
                    <strong>Current Mode:</strong> ${currentMode.toUpperCase()}
                </div>
            `;
        }
        
        function runTests() {
            clearResults();
            addResult('Starting reduced motion tests...', 'info');
            
            // Test 1: Check if matchMedia is supported
            if (!window.matchMedia) {
                addResult('❌ FAIL: matchMedia not supported in this browser', 'fail');
                return;
            }
            addResult('✓ PASS: matchMedia is supported', 'pass');
            
            // Test 2: Detect reduced motion preference
            const prefersReducedMotion = MASE.darkModeToggle.detectReducedMotion();
            addResult(`✓ PASS: Reduced motion detection completed - Result: ${prefersReducedMotion}`, 'pass');
            
            // Test 3: Check CSS media query
            const reducedMotionQuery = window.matchMedia('(prefers-reduced-motion: reduce)');
            addResult(`✓ PASS: CSS media query matches: ${reducedMotionQuery.matches}`, 'pass');
            
            // Test 4: Verify state is updated
            if (MASE.darkModeToggle.state.prefersReducedMotion === reducedMotionQuery.matches) {
                addResult('✓ PASS: State correctly reflects reduced motion preference', 'pass');
            } else {
                addResult('❌ FAIL: State does not match reduced motion preference', 'fail');
            }
            
            // Test 5: Check if animations would be disabled
            const shouldAnimate = !MASE.darkModeToggle.state.prefersReducedMotion;
            if (prefersReducedMotion && !shouldAnimate) {
                addResult('✓ PASS: Animations will be disabled when reduced motion is enabled', 'pass');
            } else if (!prefersReducedMotion && shouldAnimate) {
                addResult('✓ PASS: Animations will be enabled when reduced motion is disabled', 'pass');
            } else {
                addResult('❌ FAIL: Animation logic is incorrect', 'fail');
            }
            
            updateSystemStatus();
            
            addResult('All tests completed!', 'info');
        }
        
        function checkCSSMediaQuery() {
            clearResults();
            
            const reducedMotionQuery = window.matchMedia('(prefers-reduced-motion: reduce)');
            addResult(`CSS Media Query: (prefers-reduced-motion: reduce)`, 'info');
            addResult(`Matches: ${reducedMotionQuery.matches}`, reducedMotionQuery.matches ? 'pass' : 'info');
            addResult(`Media: ${reducedMotionQuery.media}`, 'info');
            
            // Check computed styles
            const bodyStyles = window.getComputedStyle(document.body);
            const transitionDuration = bodyStyles.transitionDuration;
            addResult(`Body transition-duration: ${transitionDuration}`, 'info');
            
            if (reducedMotionQuery.matches && transitionDuration === '0s') {
                addResult('✓ PASS: CSS correctly disables transitions for reduced motion', 'pass');
            } else if (!reducedMotionQuery.matches && transitionDuration !== '0s') {
                addResult('✓ PASS: CSS allows transitions when reduced motion is disabled', 'pass');
            }
        }
        
        function simulateReducedMotion() {
            clearResults();
            addResult('To simulate reduced motion:', 'info');
            addResult('1. Open Chrome DevTools (F12)', 'info');
            addResult('2. Open Command Menu (Ctrl+Shift+P or Cmd+Shift+P)', 'info');
            addResult('3. Type "Show Rendering"', 'info');
            addResult('4. Find "Emulate CSS media feature prefers-reduced-motion"', 'info');
            addResult('5. Select "reduce"', 'info');
            addResult('6. Run tests again to verify detection', 'info');
        }
        
        // Event listeners
        document.getElementById('run-tests').addEventListener('click', runTests);
        document.getElementById('toggle-mode').addEventListener('click', function() {
            MASE.darkModeToggle.toggle();
            updateSystemStatus();
        });
        document.getElementById('check-css').addEventListener('click', checkCSSMediaQuery);
        document.getElementById('simulate-reduced-motion').addEventListener('click', simulateReducedMotion);
        
        // Initial status update
        updateSystemStatus();
        
        // Auto-run tests on load
        setTimeout(runTests, 500);
    </script>
</body>
</html>
