<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test: Admin Bar Position Stability</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f0f0f1;
        }
        
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #1e1e1e;
            margin-bottom: 10px;
        }
        
        .test-description {
            color: #646970;
            margin-bottom: 30px;
            line-height: 1.6;
        }
        
        .test-section {
            margin-bottom: 40px;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 4px;
        }
        
        .test-section h2 {
            margin-top: 0;
            color: #0073aa;
        }
        
        .test-result {
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
            font-family: monospace;
        }
        
        .test-result.pass {
            background: #e7f7ed;
            border-left: 4px solid #00a32a;
            color: #00a32a;
        }
        
        .test-result.fail {
            background: #fcf0f1;
            border-left: 4px solid #d63638;
            color: #d63638;
        }
        
        .test-result.info {
            background: #e5f5fa;
            border-left: 4px solid #0073aa;
            color: #0073aa;
        }
        
        button {
            background: #0073aa;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
        }
        
        button:hover {
            background: #005a87;
        }
        
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        #mock-admin-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 32px;
            background: #23282d;
            z-index: 99999;
            opacity: 0;
            transition: opacity 0.1s ease;
        }
        
        #mock-admin-bar.mase-loaded {
            opacity: 1;
        }
        
        html.wp-toolbar {
            padding-top: 32px;
        }
        
        .visual-test {
            margin-top: 20px;
            padding: 20px;
            background: white;
            border: 2px dashed #ccc;
            min-height: 200px;
        }
    </style>
</head>
<body>
    <div id="mock-admin-bar"></div>
    
    <div class="test-container">
        <h1>Admin Bar Position Stability Test</h1>
        <p class="test-description">
            Tests Requirements 8.1, 8.2, 8.3, 8.4, 8.5 - Admin bar position stability during page load,
            with glassmorphism and floating effects, and FOUC prevention.
        </p>
        
        <!-- Test 1: Critical CSS Generation -->
        <div class="test-section">
            <h2>Test 1: Critical CSS Generation (Requirement 8.1, 8.2)</h2>
            <button onclick="testCriticalCSS()">Run Test</button>
            <div id="test1-results"></div>
        </div>
        
        <!-- Test 2: Admin Bar Positioning -->
        <div class="test-section">
            <h2>Test 2: Admin Bar Fixed Positioning (Requirement 8.1, 8.2)</h2>
            <button onclick="testAdminBarPositioning()">Run Test</button>
            <div id="test2-results"></div>
        </div>
        
        <!-- Test 3: Floating Effect -->
        <div class="test-section">
            <h2>Test 3: Floating Effect Positioning (Requirement 8.3)</h2>
            <button onclick="testFloatingEffect()">Run Test</button>
            <div id="test3-results"></div>
        </div>
        
        <!-- Test 4: Glassmorphism Effect -->
        <div class="test-section">
            <h2>Test 4: Glassmorphism Effect (Requirement 8.3)</h2>
            <button onclick="testGlasmorphism()">Run Test</button>
            <div id="test4-results"></div>
        </div>
        
        <!-- Test 5: FOUC Prevention -->
        <div class="test-section">
            <h2>Test 5: FOUC Prevention (Requirement 8.4)</h2>
            <button onclick="testFOUCPrevention()">Run Test</button>
            <div id="test5-results"></div>
        </div>
        
        <!-- Test 6: Layout Shift Detection -->
        <div class="test-section">
            <h2>Test 6: No Layout Shift on Load (Requirement 8.1, 8.4, 8.5)</h2>
            <button onclick="testLayoutShift()">Run Test</button>
            <div id="test6-results"></div>
        </div>
        
        <!-- Visual Test Area -->
        <div class="test-section">
            <h2>Visual Test: Admin Bar Appearance</h2>
            <p>The mock admin bar at the top should:</p>
            <ul>
                <li>Be positioned at the very top of the page</li>
                <li>Not cause any layout shift when loading</li>
                <li>Fade in smoothly (not flash)</li>
                <li>Push content down by 32px</li>
            </ul>
            <div class="visual-test">
                <p>This content should be pushed down by the admin bar.</p>
                <p>Scroll position should remain stable during page load.</p>
            </div>
        </div>
    </div>
    
    <script>
        // Mock MASE object for testing
        var MASE = {
            livePreview: {
                generateAdminBarCSS: function(settings) {
                    var css = '';
                    var adminBar = settings.admin_bar || {};
                    var visualEffects = settings.visual_effects || {};
                    var adminBarEffects = visualEffects.admin_bar || {};
                    
                    // Get admin bar height (default 32px)
                    var height = adminBar.height || 32;
                    
                    // Base positioning (always applied) - Requirements 8.1, 8.2
                    css += 'body.wp-admin #wpadminbar{';
                    css += 'position:fixed!important;';
                    css += 'top:0!important;';
                    css += 'left:0!important;';
                    css += 'right:0!important;';
                    css += 'z-index:99999!important;';
                    
                    if (adminBar.bg_color) {
                        css += 'background-color:' + adminBar.bg_color + '!important;';
                    }
                    if (adminBar.height) {
                        css += 'height:' + adminBar.height + 'px!important;';
                    }
                    css += '}';
                    
                    // Adjust body padding to match admin bar height - Requirement 8.2
                    css += 'html.wp-toolbar{';
                    css += 'padding-top:' + height + 'px!important;';
                    css += '}';
                    
                    // Glassmorphism effect (if enabled) - Requirement 8.3
                    if (adminBarEffects.glassmorphism) {
                        var blur = adminBarEffects.blur_intensity || 20;
                        css += 'body.wp-admin #wpadminbar{';
                        css += 'backdrop-filter:blur(' + blur + 'px)!important;';
                        css += '-webkit-backdrop-filter:blur(' + blur + 'px)!important;';
                        css += 'background-color:rgba(35,40,45,0.8)!important;';
                        css += '}';
                    }
                    
                    // Floating effect (if enabled) - Requirement 8.3
                    if (adminBarEffects.floating) {
                        var margin = adminBarEffects.floating_margin || 8;
                        var radius = adminBarEffects.border_radius || 8;
                        
                        css += 'body.wp-admin #wpadminbar{';
                        css += 'top:' + margin + 'px!important;';
                        css += 'left:' + margin + 'px!important;';
                        css += 'right:' + margin + 'px!important;';
                        css += 'width:calc(100% - ' + (margin * 2) + 'px)!important;';
                        css += 'border-radius:' + radius + 'px!important;';
                        css += '}';
                        
                        // Adjust body padding for floating bar - Requirement 8.3
                        css += 'html.wp-toolbar{';
                        css += 'padding-top:' + (height + margin * 2) + 'px!important;';
                        css += '}';
                    }
                    
                    return css;
                }
            }
        };
        
        // Test 1: Critical CSS Generation
        function testCriticalCSS() {
            var results = document.getElementById('test1-results');
            results.innerHTML = '';
            
            try {
                // Test critical CSS structure
                var settings = {
                    admin_bar: { height: 32 }
                };
                
                var criticalCSS = generateCriticalCSS(settings);
                
                // Check for required CSS properties
                var hasFixedPosition = criticalCSS.includes('position: fixed');
                var hasTopZero = criticalCSS.includes('top: 0');
                var hasZIndex = criticalCSS.includes('z-index: 99999');
                var hasPaddingTop = criticalCSS.includes('padding-top: 32px');
                
                if (hasFixedPosition && hasTopZero && hasZIndex && hasPaddingTop) {
                    results.innerHTML += '<div class="test-result pass">✓ Critical CSS contains all required properties</div>';
                } else {
                    results.innerHTML += '<div class="test-result fail">✗ Critical CSS missing required properties</div>';
                    if (!hasFixedPosition) results.innerHTML += '<div class="test-result fail">  Missing: position: fixed</div>';
                    if (!hasTopZero) results.innerHTML += '<div class="test-result fail">  Missing: top: 0</div>';
                    if (!hasZIndex) results.innerHTML += '<div class="test-result fail">  Missing: z-index: 99999</div>';
                    if (!hasPaddingTop) results.innerHTML += '<div class="test-result fail">  Missing: padding-top</div>';
                }
                
                results.innerHTML += '<div class="test-result info">Generated CSS:<br><pre>' + criticalCSS + '</pre></div>';
                
            } catch (error) {
                results.innerHTML += '<div class="test-result fail">✗ Error: ' + error.message + '</div>';
            }
        }
        
        // Helper function to generate critical CSS
        function generateCriticalCSS(settings) {
            var css = '';
            var adminBarHeight = settings.admin_bar.height || 32;
            
            css += '#wpadminbar {';
            css += '  position: fixed !important;';
            css += '  top: 0 !important;';
            css += '  left: 0 !important;';
            css += '  right: 0 !important;';
            css += '  z-index: 99999 !important;';
            css += '}';
            
            css += 'html.wp-toolbar {';
            css += '  padding-top: ' + adminBarHeight + 'px !important;';
            css += '}';
            
            return css;
        }
        
        // Test 2: Admin Bar Positioning
        function testAdminBarPositioning() {
            var results = document.getElementById('test2-results');
            results.innerHTML = '';
            
            try {
                var adminBar = document.getElementById('mock-admin-bar');
                var computedStyle = window.getComputedStyle(adminBar);
                
                var position = computedStyle.position;
                var top = computedStyle.top;
                var left = computedStyle.left;
                var right = computedStyle.right;
                var zIndex = computedStyle.zIndex;
                
                results.innerHTML += '<div class="test-result info">Position: ' + position + '</div>';
                results.innerHTML += '<div class="test-result info">Top: ' + top + '</div>';
                results.innerHTML += '<div class="test-result info">Left: ' + left + '</div>';
                results.innerHTML += '<div class="test-result info">Right: ' + right + '</div>';
                results.innerHTML += '<div class="test-result info">Z-Index: ' + zIndex + '</div>';
                
                if (position === 'fixed' && top === '0px' && left === '0px' && right === '0px' && zIndex === '99999') {
                    results.innerHTML += '<div class="test-result pass">✓ Admin bar has correct positioning</div>';
                } else {
                    results.innerHTML += '<div class="test-result fail">✗ Admin bar positioning incorrect</div>';
                }
                
            } catch (error) {
                results.innerHTML += '<div class="test-result fail">✗ Error: ' + error.message + '</div>';
            }
        }
        
        // Test 3: Floating Effect
        function testFloatingEffect() {
            var results = document.getElementById('test3-results');
            results.innerHTML = '';
            
            try {
                var settings = {
                    admin_bar: { height: 32 },
                    visual_effects: {
                        admin_bar: {
                            floating: true,
                            floating_margin: 8,
                            border_radius: 8
                        }
                    }
                };
                
                var css = MASE.livePreview.generateAdminBarCSS(settings);
                
                var hasFloatingTop = css.includes('top:8px');
                var hasFloatingMargin = css.includes('left:8px') && css.includes('right:8px');
                var hasWidth = css.includes('width:calc(100% - 16px)');
                var hasBorderRadius = css.includes('border-radius:8px');
                var hasAdjustedPadding = css.includes('padding-top:48px'); // 32 + 8*2
                
                if (hasFloatingTop && hasFloatingMargin && hasWidth && hasBorderRadius && hasAdjustedPadding) {
                    results.innerHTML += '<div class="test-result pass">✓ Floating effect CSS generated correctly</div>';
                } else {
                    results.innerHTML += '<div class="test-result fail">✗ Floating effect CSS incomplete</div>';
                    if (!hasFloatingTop) results.innerHTML += '<div class="test-result fail">  Missing: top margin</div>';
                    if (!hasFloatingMargin) results.innerHTML += '<div class="test-result fail">  Missing: left/right margin</div>';
                    if (!hasWidth) results.innerHTML += '<div class="test-result fail">  Missing: width calculation</div>';
                    if (!hasBorderRadius) results.innerHTML += '<div class="test-result fail">  Missing: border radius</div>';
                    if (!hasAdjustedPadding) results.innerHTML += '<div class="test-result fail">  Missing: adjusted padding</div>';
                }
                
                results.innerHTML += '<div class="test-result info">Generated CSS (excerpt):<br><pre>' + css.substring(0, 500) + '...</pre></div>';
                
            } catch (error) {
                results.innerHTML += '<div class="test-result fail">✗ Error: ' + error.message + '</div>';
            }
        }
        
        // Test 4: Glassmorphism Effect
        function testGlasmorphism() {
            var results = document.getElementById('test4-results');
            results.innerHTML = '';
            
            try {
                var settings = {
                    admin_bar: { height: 32 },
                    visual_effects: {
                        admin_bar: {
                            glassmorphism: true,
                            blur_intensity: 20
                        }
                    }
                };
                
                var css = MASE.livePreview.generateAdminBarCSS(settings);
                
                var hasBackdropFilter = css.includes('backdrop-filter:blur(20px)');
                var hasWebkitBackdropFilter = css.includes('-webkit-backdrop-filter:blur(20px)');
                var hasTransparentBg = css.includes('rgba(35,40,45,0.8)');
                
                if (hasBackdropFilter && hasWebkitBackdropFilter && hasTransparentBg) {
                    results.innerHTML += '<div class="test-result pass">✓ Glassmorphism effect CSS generated correctly</div>';
                } else {
                    results.innerHTML += '<div class="test-result fail">✗ Glassmorphism effect CSS incomplete</div>';
                    if (!hasBackdropFilter) results.innerHTML += '<div class="test-result fail">  Missing: backdrop-filter</div>';
                    if (!hasWebkitBackdropFilter) results.innerHTML += '<div class="test-result fail">  Missing: -webkit-backdrop-filter</div>';
                    if (!hasTransparentBg) results.innerHTML += '<div class="test-result fail">  Missing: transparent background</div>';
                }
                
            } catch (error) {
                results.innerHTML += '<div class="test-result fail">✗ Error: ' + error.message + '</div>';
            }
        }
        
        // Test 5: FOUC Prevention
        function testFOUCPrevention() {
            var results = document.getElementById('test5-results');
            results.innerHTML = '';
            
            try {
                var adminBar = document.getElementById('mock-admin-bar');
                var computedStyle = window.getComputedStyle(adminBar);
                
                var opacity = computedStyle.opacity;
                var transition = computedStyle.transition;
                
                results.innerHTML += '<div class="test-result info">Initial Opacity: ' + opacity + '</div>';
                results.innerHTML += '<div class="test-result info">Transition: ' + transition + '</div>';
                
                // Check if opacity is 0 initially (before .mase-loaded class)
                if (opacity === '0' || parseFloat(opacity) < 0.1) {
                    results.innerHTML += '<div class="test-result pass">✓ Admin bar hidden initially (opacity: 0)</div>';
                } else {
                    results.innerHTML += '<div class="test-result fail">✗ Admin bar not hidden initially</div>';
                }
                
                // Check if transition is set
                if (transition.includes('opacity')) {
                    results.innerHTML += '<div class="test-result pass">✓ Opacity transition configured</div>';
                } else {
                    results.innerHTML += '<div class="test-result fail">✗ Opacity transition not configured</div>';
                }
                
                // Simulate adding .mase-loaded class
                adminBar.classList.add('mase-loaded');
                
                setTimeout(function() {
                    var newOpacity = window.getComputedStyle(adminBar).opacity;
                    results.innerHTML += '<div class="test-result info">Opacity after .mase-loaded: ' + newOpacity + '</div>';
                    
                    if (newOpacity === '1' || parseFloat(newOpacity) > 0.9) {
                        results.innerHTML += '<div class="test-result pass">✓ Admin bar visible after .mase-loaded class</div>';
                    } else {
                        results.innerHTML += '<div class="test-result fail">✗ Admin bar not fully visible after .mase-loaded class</div>';
                    }
                }, 200);
                
            } catch (error) {
                results.innerHTML += '<div class="test-result fail">✗ Error: ' + error.message + '</div>';
            }
        }
        
        // Test 6: Layout Shift Detection
        function testLayoutShift() {
            var results = document.getElementById('test6-results');
            results.innerHTML = '';
            
            try {
                var html = document.documentElement;
                var computedStyle = window.getComputedStyle(html);
                var paddingTop = computedStyle.paddingTop;
                
                results.innerHTML += '<div class="test-result info">HTML padding-top: ' + paddingTop + '</div>';
                
                if (paddingTop === '32px') {
                    results.innerHTML += '<div class="test-result pass">✓ HTML has correct padding-top to prevent layout shift</div>';
                } else {
                    results.innerHTML += '<div class="test-result fail">✗ HTML padding-top incorrect (expected 32px, got ' + paddingTop + ')</div>';
                }
                
                // Check if content is pushed down
                var testContainer = document.querySelector('.test-container');
                var containerTop = testContainer.getBoundingClientRect().top;
                
                results.innerHTML += '<div class="test-result info">Content top position: ' + containerTop + 'px</div>';
                
                if (containerTop >= 32) {
                    results.innerHTML += '<div class="test-result pass">✓ Content properly pushed down by admin bar</div>';
                } else {
                    results.innerHTML += '<div class="test-result fail">✗ Content not properly pushed down</div>';
                }
                
            } catch (error) {
                results.innerHTML += '<div class="test-result fail">✗ Error: ' + error.message + '</div>';
            }
        }
        
        // Add wp-toolbar class to html element for testing
        document.documentElement.classList.add('wp-toolbar');
        
        // Simulate window load event to add .mase-loaded class
        window.addEventListener('load', function() {
            document.getElementById('mock-admin-bar').classList.add('mase-loaded');
        });
    </script>
</body>
</html>
