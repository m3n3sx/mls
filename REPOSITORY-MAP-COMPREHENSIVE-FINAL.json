{
  "repository_analysis": {
    "analysis_date": "2025-10-29",
    "total_files_analyzed": 150,
    "analysis_scope": "Complete codebase structure with focus on asset enqueuing and live preview architecture"
  },

  "php_backend": {
    "core_classes": {
      "includes/class-mase-admin.php": {
        "lines": 5712,
        "purpose": "Main admin interface controller",
        "responsibilities": [
          "Asset enqueuing (CSS/JS)",
          "AJAX handler registration",
          "Admin menu registration",
          "Settings page rendering",
          "Custom CSS injection",
          "Global dark mode FAB rendering",
          "Security (nonce verification, capability checks)"
        ],
        "key_methods": {
          "enqueue_assets": {
            "line": 260,
            "hook": "admin_enqueue_scripts",
            "conditional": "Only on 'toplevel_page_mase-settings'",
            "purpose": "Enqueues all CSS and JS assets for settings page"
          },
          "enqueue_global_dark_mode": {
            "line": 178,
            "hook": "admin_enqueue_scripts",
            "conditional": "All admin pages",
            "purpose": "Enqueues global dark mode toggle FAB"
          },
          "enqueue_active_template": {
            "line": 169,
            "hook": "admin_enqueue_scripts",
            "priority": 20,
            "purpose": "Enqueues active theme template CSS"
          },
          "inject_custom_css": {
            "line": 1000,
            "hook": "admin_head",
            "priority": 999,
            "purpose": "Injects generated CSS with caching and error recovery"
          },
          "render_global_dark_mode_fab": {
            "line": 215,
            "hook": "admin_footer",
            "purpose": "Renders floating dark mode toggle button"
          }
        },
        "ajax_handlers": {
          "settings": [
            "mase_save_settings",
            "mase_export_settings",
            "mase_import_settings",
            "mase_reset_settings"
          ],
          "palettes": [
            "mase_apply_palette",
            "mase_save_custom_palette",
            "mase_delete_custom_palette"
          ],
          "templates": [
            "mase_apply_template",
            "mase_save_custom_template",
            "mase_delete_custom_template",
            "mase_apply_theme_template",
            "mase_get_templates"
          ],
          "backups": [
            "mase_create_backup",
            "mase_restore_backup",
            "mase_get_backups"
          ],
          "uploads": [
            "mase_upload_menu_logo",
            "mase_upload_login_logo",
            "mase_upload_login_background",
            "mase_upload_background_image",
            "mase_select_background_image",
            "mase_remove_background_image"
          ],
          "features": [
            "mase_toggle_dark_mode",
            "mase_get_pattern_library",
            "mase_log_client_error",
            "mase_get_button_defaults",
            "mase_reset_button_type",
            "mase_reset_all_buttons"
          ]
        }
      },
      "includes/class-mase-settings.php": {
        "purpose": "Settings CRUD operations and validation",
        "responsibilities": [
          "Get/update settings",
          "Validate input",
          "Palette management",
          "Template management",
          "Default values"
        ]
      },
      "includes/class-mase-css-generator.php": {
        "purpose": "Dynamic CSS generation",
        "responsibilities": [
          "Generate CSS from settings",
          "Minification",
          "Dark mode CSS",
          "Button CSS",
          "Login CSS"
        ]
      },
      "includes/class-mase-cache.php": {
        "purpose": "Performance caching layer",
        "responsibilities": [
          "Cache generated CSS",
          "Mode-specific caching (light/dark)",
          "Cache invalidation",
          "Cache warming"
        ]
      },
      "includes/class-mase-cachemanager.php": {
        "purpose": "Cache management utilities",
        "responsibilities": [
          "Static cache methods",
          "Cache key management",
          "Expiration handling"
        ]
      },
      "includes/class-mase-template-manager.php": {
        "purpose": "Theme template system",
        "responsibilities": [
          "Template registration",
          "Template activation",
          "Template CSS enqueuing",
          "Category management"
        ]
      },
      "includes/class-mase-rest-api.php": {
        "purpose": "REST API endpoints",
        "responsibilities": [
          "API route registration",
          "API authentication",
          "API responses"
        ]
      },
      "includes/class-mase-migration.php": {
        "purpose": "Database migration handling",
        "responsibilities": [
          "Version migrations",
          "Data structure updates",
          "Backward compatibility"
        ]
      },
      "includes/class-mase-background-migration.php": {
        "purpose": "Background system migration",
        "responsibilities": [
          "Migrate old background settings",
          "Convert to new structure"
        ]
      },
      "includes/class-mase-mobile-optimizer.php": {
        "purpose": "Mobile optimization",
        "responsibilities": [
          "Responsive CSS generation",
          "Mobile-specific optimizations"
        ]
      }
    },
    "admin_templates": {
      "includes/admin-settings-page.php": {
        "purpose": "Main settings page HTML structure",
        "contains": [
          "Header with toggles",
          "Tab navigation",
          "Tab content sections",
          "Form controls"
        ]
      },
      "includes/backgrounds-tab-content.php": {
        "purpose": "Background settings tab"
      },
      "includes/form-controls-tab-content.php": {
        "purpose": "Form controls styling tab"
      },
      "includes/login-tab-section.php": {
        "purpose": "Login page customization tab"
      },
      "includes/universal-buttons-tab-content.php": {
        "purpose": "Universal button styling tab"
      },
      "includes/visual-effects-section.php": {
        "purpose": "Visual effects settings"
      },
      "includes/widgets-tab-content.php": {
        "purpose": "Widget styling tab"
      },
      "includes/templates/content-tab.php": {
        "purpose": "Content area styling tab"
      }
    }
  },

  "javascript_frontend": {
    "asset_enqueue_order": {
      "description": "Assets load in specific order for dependency management",
      "order": [
        "1. wp-color-picker (WordPress core)",
        "2. mase-asset-loader.js (utilities first - debounce/throttle)",
        "3. mase-admin.css (main styles)",
        "4. mase-palettes.css",
        "5. mase-templates.css",
        "6. mase-template-picker.css",
        "7. mase-accessibility.css",
        "8. mase-responsive.css",
        "9. mase-admin.js (main functionality)",
        "10. mase-template-picker.js",
        "11. Inline script for template initialization",
        "12. mase-gradient-builder.js",
        "13. mase-pattern-library.js + CSS",
        "14. mase-position-picker.js",
        "15. mase-compatibility.js",
        "16. mase-error-recovery.js",
        "17. mase-background-accessibility.js"
      ],
      "evidence": "[includes/class-mase-admin.php:260-510]"
    },
    "main_scripts": {
      "assets/js/mase-admin.js": {
        "purpose": "Main admin interface functionality",
        "dependencies": ["jquery", "wp-color-picker", "mase-asset-loader"],
        "enqueue_line": 327,
        "key_modules": [
          "MASE_DEBUG - Debug logging",
          "MASE.livePreview - Live preview (INTEGRATED, not separate file)",
          "MASE.darkMode - Dark mode toggle",
          "MASE.paletteManager - Palette management",
          "MASE.templateManager - Template management",
          "MASE.settings - Settings save/load"
        ],
        "critical_note": "Live preview is INTEGRATED into this file. There is NO separate mase-admin-live-preview.js file.",
        "localized_data": {
          "maseL10n": "Translations and AJAX config",
          "maseAdmin": "Settings, palettes, templates, theme templates"
        },
        "fouc_prevention": "Inline script before main script checks localStorage and applies dark mode class immediately"
      },
      "assets/js/mase-global-dark-mode.js": {
        "purpose": "Global dark mode FAB functionality",
        "dependencies": ["jquery"],
        "enqueue_line": 187,
        "scope": "All admin pages",
        "localized_data": "maseGlobalDarkMode (ajaxUrl, nonce)"
      },
      "assets/js/mase-template-picker.js": {
        "purpose": "Template picker grid functionality",
        "dependencies": ["jquery", "mase-admin"],
        "enqueue_line": 336,
        "initialization": "Inline script after enqueue (lines 343-423)"
      },
      "assets/js/mase-accessibility.js": {
        "purpose": "Accessibility features",
        "dependencies": ["jquery"],
        "scope": "Settings page"
      },
      "assets/js/mase-pattern-library.js": {
        "purpose": "Pattern library UI",
        "dependencies": ["jquery", "mase-admin", "mase-asset-loader"],
        "enqueue_line": 447,
        "localized_data": "masePatternLibrary"
      },
      "assets/js/mase-position-picker.js": {
        "purpose": "Background position picker",
        "dependencies": ["jquery", "mase-admin", "mase-asset-loader"],
        "enqueue_line": 467
      }
    },
    "modules": {
      "assets/js/modules/mase-asset-loader.js": {
        "purpose": "Utility functions (debounce, throttle)",
        "dependencies": ["jquery"],
        "enqueue_line": 318,
        "priority": "FIRST - Must load before other modules",
        "provides": "Debounce and throttle utilities for other modules"
      },
      "assets/js/modules/mase-gradient-builder.js": {
        "purpose": "Gradient builder UI",
        "dependencies": ["jquery", "wp-color-picker", "mase-admin", "mase-asset-loader"],
        "enqueue_line": 431,
        "loading": "On demand when gradient tab active"
      },
      "assets/js/modules/mase-compatibility.js": {
        "purpose": "Browser feature detection and fallbacks",
        "dependencies": ["jquery"],
        "enqueue_line": 478,
        "priority": "Early - Sets up fallbacks before other modules"
      },
      "assets/js/modules/mase-error-recovery.js": {
        "purpose": "Error recovery mechanisms",
        "dependencies": ["jquery", "mase-admin"],
        "enqueue_line": 489,
        "priority": "Early - Sets up global error handlers"
      },
      "assets/js/modules/mase-background-accessibility.js": {
        "purpose": "Accessibility features for backgrounds",
        "dependencies": ["jquery", "mase-admin", "mase-gradient-builder", "mase-pattern-library", "mase-position-picker"],
        "enqueue_line": 505,
        "requirements": "WCAG 2.1 AA compliance"
      },
      "assets/js/modules/state-manager.js": {
        "purpose": "State management",
        "status": "Module file exists but not enqueued separately",
        "note": "Functionality may be integrated into mase-admin.js"
      },
      "assets/js/modules/preview-engine.js": {
        "purpose": "Preview engine",
        "status": "Module file exists but not enqueued separately",
        "note": "Functionality may be integrated into mase-admin.js"
      },
      "assets/js/modules/palette-manager.js": {
        "purpose": "Palette management",
        "status": "Module file exists but not enqueued separately",
        "note": "Functionality integrated into mase-admin.js as MASE.paletteManager"
      },
      "assets/js/modules/template-manager.js": {
        "purpose": "Template management",
        "status": "Module file exists but not enqueued separately",
        "note": "Functionality integrated into mase-admin.js as MASE.templateManager"
      },
      "assets/js/modules/color-system.js": {
        "purpose": "Color system utilities",
        "status": "Module file exists but not enqueued separately"
      },
      "assets/js/modules/typography.js": {
        "purpose": "Typography utilities",
        "status": "Module file exists but not enqueued separately"
      },
      "assets/js/modules/event-bus.js": {
        "purpose": "Event bus for module communication",
        "status": "Module file exists but not enqueued separately"
      }
    },
    "non_existent_files": [
      {
        "file": "assets/js/mase-admin-live-preview.js",
        "status": "DOES NOT EXIST",
        "reason": "Live preview is integrated into mase-admin.js to prevent duplicate event handlers",
        "evidence": "[includes/class-mase-admin.php:632-639]",
        "module_location": "MASE.livePreview module in assets/js/mase-admin.js"
      }
    ]
  },

  "css_stylesheets": {
    "core_styles": {
      "assets/css/mase-admin.css": {
        "purpose": "Main admin interface styles",
        "dependencies": ["wp-color-picker"],
        "enqueue_line": 269,
        "contains": [
          "Design tokens (CSS custom properties)",
          "Header styles",
          "Tab navigation",
          "Card components",
          "Form controls",
          "Dark mode styles",
          "FAB styles"
        ],
        "backup_files": [
          "mase-admin.css.backup",
          "mase-admin.css.old",
          "mase-admin.css.backup-20251029-130045",
          "mase-admin.css.backup-before-optimization-20251029-141932",
          "mase-admin.css.backup-before-optimization-20251029-141942"
        ]
      },
      "assets/css/mase-palettes.css": {
        "purpose": "Palette card styles",
        "dependencies": ["mase-admin"],
        "enqueue_line": 277
      },
      "assets/css/mase-templates.css": {
        "purpose": "Template card styles",
        "dependencies": ["mase-admin"],
        "enqueue_line": 285
      },
      "assets/css/mase-template-picker.css": {
        "purpose": "Template picker grid styles",
        "dependencies": ["mase-admin"],
        "enqueue_line": 293
      },
      "assets/css/mase-accessibility.css": {
        "purpose": "Accessibility enhancements",
        "dependencies": ["mase-admin"],
        "enqueue_line": 301
      },
      "assets/css/mase-responsive.css": {
        "purpose": "Responsive design styles",
        "dependencies": ["mase-admin"],
        "enqueue_line": 309
      },
      "assets/css/mase-pattern-library.css": {
        "purpose": "Pattern library UI styles",
        "dependencies": [],
        "enqueue_line": 440
      },
      "assets/css/mase-animation-editor.css": {
        "purpose": "Animation editor styles",
        "status": "File exists but not enqueued in class-mase-admin.php"
      }
    },
    "theme_templates": {
      "directory": "assets/css/themes/",
      "files": [
        "floral-theme.css",
        "gaming-theme.css",
        "glass-theme.css",
        "gradient-theme.css",
        "minimal-theme.css",
        "professional-theme.css",
        "retro-theme.css",
        "terminal-theme.css"
      ],
      "enqueue_method": "Dynamic via MASE_Template_Manager::enqueue_template_css()",
      "enqueue_hook": "admin_enqueue_scripts (priority 20)"
    }
  },

  "live_preview_architecture": {
    "integration": "INTEGRATED into mase-admin.js as MASE.livePreview module",
    "not_separate_file": true,
    "primary_file": "assets/js/mase-admin.js",
    "module_name": "MASE.livePreview",
    "purpose": "Prevent duplicate event handlers and race conditions",
    "evidence": "[includes/class-mase-admin.php:632-639]",
    "comment_in_code": "NOTE: Live preview functionality is handled by MASE.livePreview module. All live preview functionality is in assets/js/mase-admin.js to prevent duplicate event handlers and race conditions.",
    "no_separate_enqueue": "No wp_enqueue_script() call for live preview - it's part of mase-admin.js"
  },

  "inline_scripts": {
    "dark_mode_fouc_prevention": {
      "location": "[includes/class-mase-admin.php:514-543]",
      "position": "before mase-admin.js",
      "purpose": "Prevent Flash of Unstyled Content by applying dark mode class synchronously",
      "execution": "< 50ms",
      "checks": [
        "localStorage.getItem('mase_dark_mode')",
        "User meta fallback",
        "Applies .mase-dark-mode class if dark"
      ]
    },
    "template_picker_initialization": {
      "location": "[includes/class-mase-admin.php:343-423]",
      "position": "after mase-admin.js",
      "purpose": "Initialize template picker grid with theme templates",
      "triggers": [
        "Document ready",
        "Templates tab click"
      ],
      "data_source": "window.maseAdmin.themeTemplates"
    },
    "dashicons_pointer_events_fix": {
      "location": "[includes/class-mase-admin.php:745-820]",
      "method": "wp_add_inline_style()",
      "purpose": "Fix dashicons blocking toggle clicks",
      "critical": "Prevents Playwright test failures",
      "css_rules": [
        "pointer-events: none on dashicons",
        "pointer-events: auto on checkboxes",
        "cursor: pointer on labels"
      ]
    },
    "force_adminbar_visibility": {
      "location": "[includes/class-mase-admin.php:900-915]",
      "hook": "admin_head",
      "purpose": "Force admin bar visibility on settings page",
      "css_rules": [
        "display: flex !important",
        "visibility: visible !important",
        "opacity: 1 !important"
      ]
    }
  },

  "localized_data": {
    "maseL10n": {
      "script_handle": "mase-admin",
      "location": "[includes/class-mase-admin.php:545-630]",
      "contains": [
        "ajaxUrl",
        "nonce",
        "Dark mode translations",
        "UI messages",
        "Error messages",
        "Button styling strings",
        "Background system strings"
      ]
    },
    "maseAdmin": {
      "script_handle": "mase-admin",
      "location": "[includes/class-mase-admin.php:641-700]",
      "contains": [
        "ajaxUrl",
        "nonce",
        "debug flag",
        "palettes data",
        "templates data",
        "gradientPresets",
        "themeTemplates",
        "activeTemplate",
        "templateCategories",
        "strings (all UI messages)"
      ]
    },
    "maseGlobalDarkMode": {
      "script_handle": "mase-global-dark-mode",
      "location": "[includes/class-mase-admin.php:195-201]",
      "contains": [
        "ajaxUrl",
        "nonce"
      ]
    },
    "masePatternLibrary": {
      "script_handle": "mase-pattern-library",
      "location": "[includes/class-mase-admin.php:456-465]",
      "contains": "Pattern library data",
      "note": "Also loaded on demand via AJAX"
    }
  },

  "test_files": {
    "visual_interactive": {
      "directory": "tests/visual-interactive/",
      "purpose": "Comprehensive visual and interactive testing",
      "structure": {
        "config.cjs": "Test configuration",
        "runner.cjs": "Test runner",
        "orchestrator.cjs": "Test orchestration",
        "reporter.cjs": "Report generation",
        "helpers.cjs": "Test helpers",
        "scenarios/": "Test scenarios by feature"
      },
      "scenario_categories": [
        "admin-bar",
        "advanced",
        "backgrounds",
        "buttons",
        "content",
        "effects",
        "form-controls",
        "general",
        "live-preview",
        "login",
        "menu",
        "palettes",
        "responsive",
        "templates",
        "typography",
        "widgets"
      ]
    },
    "e2e": {
      "directory": "tests/e2e/",
      "purpose": "End-to-end Playwright tests",
      "files": [
        "browser-compatibility-test.spec.js",
        "capture-redesign-screenshots.spec.js",
        "comprehensive-functionality-test.spec.js",
        "quick-smoke-test.spec.js",
        "visual-redesign-regression.spec.js"
      ],
      "config": "playwright.config.js (root)",
      "auth": "tests/e2e/.auth/ (authentication state)"
    },
    "accessibility": {
      "directory": "tests/accessibility/",
      "purpose": "WCAG compliance testing",
      "files": [
        "contrast-verification.js",
        "keyboard-navigation.js",
        "screen-reader-test.js",
        "run-all-tests.js"
      ]
    },
    "visual_testing": {
      "directory": "tests/visual-testing/",
      "purpose": "Visual regression testing",
      "files": [
        "glassmorphism-2024-verification.html",
        "glassmorphism-2025-test.html",
        "template-picker-test.html",
        "theme-templates-preview.html"
      ]
    }
  },

  "key_directories": {
    "includes/": "PHP backend classes and admin functionality",
    "assets/js/": "JavaScript files for admin interface",
    "assets/js/modules/": "JavaScript modules (some integrated, some standalone)",
    "assets/css/": "Stylesheets for admin styling",
    "assets/css/themes/": "Theme template stylesheets",
    "tests/": "Testing suites",
    "tests/visual-interactive/": "Visual and interactive tests",
    "tests/e2e/": "End-to-end Playwright tests",
    "tests/accessibility/": "Accessibility tests",
    "docs/": "Documentation files",
    "docs/screenshots/": "Screenshot assets",
    "languages/": "Translation files"
  },

  "critical_findings": {
    "no_separate_live_preview_file": {
      "finding": "Live preview is NOT a separate enqueued file",
      "location": "Integrated into assets/js/mase-admin.js as MASE.livePreview module",
      "reason": "Prevent duplicate event handlers and race conditions",
      "evidence": "[includes/class-mase-admin.php:632-639]"
    },
    "conditional_loading": {
      "finding": "Assets only load on MASE settings page",
      "condition": "toplevel_page_mase-settings",
      "exception": "Global dark mode assets load on all admin pages",
      "evidence": "[includes/class-mase-admin.php:260-263]"
    },
    "dependency_chain": {
      "finding": "Strict dependency order enforced",
      "order": "mase-asset-loader → mase-admin → other modules",
      "reason": "Asset loader provides utilities needed by other modules",
      "evidence": "[includes/class-mase-admin.php:318-326]"
    },
    "inline_scripts_critical": {
      "finding": "Multiple inline scripts for critical functionality",
      "scripts": [
        "Dark mode FOUC prevention (before mase-admin)",
        "Template picker initialization (after mase-admin)",
        "Dashicons pointer-events fix (inline style)",
        "Admin bar visibility fix (admin_head hook)"
      ],
      "purpose": "Ensure functionality before main scripts load or override conflicts"
    },
    "module_integration_pattern": {
      "finding": "Some modules are files, some are integrated",
      "standalone_modules": [
        "mase-asset-loader.js",
        "mase-gradient-builder.js",
        "mase-pattern-library.js",
        "mase-position-picker.js",
        "mase-compatibility.js",
        "mase-error-recovery.js",
        "mase-background-accessibility.js"
      ],
      "integrated_modules": [
        "livePreview (in mase-admin.js)",
        "darkMode (in mase-admin.js)",
        "paletteManager (in mase-admin.js)",
        "templateManager (in mase-admin.js)",
        "settings (in mase-admin.js)"
      ],
      "reason": "Core functionality integrated to prevent conflicts, specialized features as separate modules"
    }
  },

  "recent_changes": {
    "template_picker_inline_script_fix": {
      "file": "includes/class-mase-admin.php",
      "line": 345,
      "change": "Wrapped jQuery in IIFE: (function($) { $(document).ready(...) })(jQuery)",
      "reason": "Prevent jQuery conflicts in WordPress environment",
      "date": "2025-10-29",
      "evidence": "Applied diff shows change from jQuery(document).ready to IIFE pattern"
    }
  },

  "performance_optimizations": {
    "css_caching": {
      "strategy": "Multi-level cache with mode-specific keys",
      "cache_keys": [
        "mase_generated_css (general)",
        "mase_light_mode_css (light mode)",
        "mase_dark_mode_css (dark mode)",
        "mase_button_css (button styles)",
        "mase_login_css (login page)"
      ],
      "duration": "3600 seconds (1 hour)",
      "invalidation": "On settings save",
      "warming": "Pre-generate both modes after save"
    },
    "conditional_loading": {
      "strategy": "Only load assets on settings page",
      "exception": "Global dark mode (all pages)",
      "benefit": "Reduces overhead on other admin pages"
    },
    "lazy_loading": {
      "strategy": "Some modules load on demand",
      "example": "Gradient builder loads when gradient tab active",
      "implementation": "Via mase-asset-loader.js utilities"
    }
  },

  "security_implementation": {
    "csrf_protection": {
      "method": "check_ajax_referer()",
      "nonce_action": "mase_save_settings",
      "all_ajax_handlers": "Verify nonce before processing"
    },
    "authorization": {
      "method": "current_user_can('manage_options')",
      "all_ajax_handlers": "Check capability before processing"
    },
    "input_validation": {
      "method": "MASE_Settings::validate()",
      "sanitization": [
        "sanitize_text_field()",
        "sanitize_hex_color()",
        "absint()",
        "wp_kses_post()"
      ]
    },
    "file_uploads": {
      "validation": [
        "File type (PNG, JPG, WebP, SVG)",
        "File size (max 5MB)",
        "MIME type verification",
        "Extension validation",
        "SVG sanitization"
      ]
    }
  }
}
