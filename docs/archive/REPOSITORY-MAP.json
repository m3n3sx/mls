{
  "plugin_info": {
    "name": "Modern Admin Styler Enterprise (MASE)",
    "version": "1.3.0",
    "description": "Enterprise-grade WordPress admin styling plugin with global dark mode",
    "main_file": "modern-admin-styler.php",
    "last_updated": "2025-10-29",
    "status": "CRITICAL FIX APPLIED - Nonce mismatch resolved"
  },
  
  "recent_critical_fix": {
    "issue": "Nonce mismatch in global dark mode AJAX handler",
    "evidence": {
      "php_creates_nonce": "[includes/class-mase-admin.php:181] wp_create_nonce('mase_toggle_dark_mode')",
      "php_checks_nonce": "[includes/class-mase-admin.php:3469] check_ajax_referer('mase_save_settings') - WRONG!",
      "js_sends_nonce": "[assets/js/mase-global-dark-mode.js:159] nonce: maseGlobalDarkMode.nonce"
    },
    "fix_applied": "Changed check_ajax_referer() to use 'mase_toggle_dark_mode' instead of 'mase_save_settings'",
    "impact": "All dark mode toggle requests were failing with 403 Forbidden",
    "status": "FIXED"
  },
  
  "duplicate_code_removed": {
    "issue": "Duplicate handle_ajax_toggle_dark_mode() method",
    "location_removed": "[includes/class-mase-admin.php:1919-1967]",
    "location_kept": "[includes/class-mase-admin.php:3465]",
    "reason": "Simpler implementation removed, comprehensive implementation with validation kept",
    "status": "RESOLVED"
  },
  
  "php_files": {
    "core_classes": [
      {
        "file": "includes/class-mase-admin.php",
        "class": "MASE_Admin",
        "lines": 5483,
        "purpose": "Admin interface, asset enqueuing, AJAX handlers",
        "key_methods": [
          "enqueue_assets($hook) - Conditional asset loading for settings page",
          "enqueue_global_dark_mode($hook) - NEW: Global dark mode assets on all pages",
          "render_global_dark_mode_fab() - NEW: Floating action button for dark mode",
          "handle_ajax_toggle_dark_mode() - FIXED: Dark mode toggle with correct nonce",
          "handle_ajax_save_settings() - Main settings save",
          "ajax_apply_palette() - Palette application",
          "ajax_apply_template() - Template application"
        ],
        "ajax_handlers": [
          "mase_save_settings",
          "mase_export_settings",
          "mase_import_settings",
          "mase_reset_settings",
          "mase_apply_palette",
          "mase_save_custom_palette",
          "mase_delete_custom_palette",
          "mase_apply_template",
          "mase_save_custom_template",
          "mase_delete_custom_template",
          "mase_create_backup",
          "mase_restore_backup",
          "mase_get_backups",
          "mase_upload_menu_logo",
          "mase_upload_login_logo",
          "mase_upload_login_background",
          "mase_upload_background_image",
          "mase_select_background_image",
          "mase_remove_background_image",
          "mase_get_pattern_library",
          "mase_toggle_dark_mode - FIXED: Now uses correct nonce",
          "mase_log_client_error",
          "mase_get_button_defaults",
          "mase_reset_button_type",
          "mase_reset_all_buttons"
        ]
      },
      {
        "file": "includes/class-mase-settings.php",
        "class": "MASE_Settings",
        "purpose": "Settings storage, retrieval, validation, defaults"
      },
      {
        "file": "includes/class-mase-css-generator.php",
        "class": "MASE_CSS_Generator",
        "purpose": "Generates CSS from settings with mode-specific caching"
      },
      {
        "file": "includes/class-mase-cache.php",
        "class": "MASE_Cache",
        "purpose": "CSS caching using WordPress transients"
      },
      {
        "file": "includes/class-mase-cachemanager.php",
        "class": "MASE_CacheManager",
        "purpose": "Static cache management wrapper"
      },
      {
        "file": "includes/class-mase-migration.php",
        "class": "MASE_Migration",
        "purpose": "Version migration and upgrade handling"
      },
      {
        "file": "includes/class-mase-mobile-optimizer.php",
        "class": "MASE_Mobile_Optimizer",
        "purpose": "Mobile device optimization and detection"
      },
      {
        "file": "includes/class-mase-rest-api.php",
        "class": "MASE_REST_API",
        "purpose": "REST API endpoints"
      },
      {
        "file": "includes/class-mase-background-migration.php",
        "class": "MASE_Background_Migration",
        "purpose": "Background system migration"
      }
    ],
    "template_files": [
      "includes/admin-settings-page.php",
      "includes/backgrounds-tab-content.php",
      "includes/form-controls-tab-content.php",
      "includes/login-tab-section.php",
      "includes/universal-buttons-tab-content.php",
      "includes/visual-effects-section.php",
      "includes/widgets-tab-content.php",
      "includes/templates/content-tab.php"
    ]
  },
  
  "js_files": {
    "main_scripts": [
      {
        "file": "assets/js/mase-admin.js",
        "purpose": "Main admin interface JavaScript with integrated live preview",
        "dependencies": ["jquery", "wp-color-picker", "mase-asset-loader"],
        "note": "Live preview is INTEGRATED into this file, not separate"
      },
      {
        "file": "assets/js/mase-global-dark-mode.js",
        "purpose": "NEW: Global dark mode toggle for all admin pages",
        "dependencies": ["jquery"],
        "localized_data": "maseGlobalDarkMode",
        "ajax_action": "mase_toggle_dark_mode",
        "nonce": "mase_toggle_dark_mode - FIXED: Now matches PHP handler",
        "status": "WORKING after nonce fix"
      },
      {
        "file": "assets/js/mase-accessibility.js",
        "purpose": "Accessibility features (WCAG 2.1 AA compliance)",
        "dependencies": ["jquery"]
      },
      {
        "file": "assets/js/mase-pattern-library.js",
        "purpose": "Pattern library for backgrounds",
        "dependencies": ["jquery", "mase-admin", "mase-asset-loader"]
      },
      {
        "file": "assets/js/mase-position-picker.js",
        "purpose": "Background position picker UI",
        "dependencies": ["jquery", "mase-admin", "mase-asset-loader"]
      }
    ],
    "modules": [
      "assets/js/modules/mase-asset-loader.js - MUST load FIRST",
      "assets/js/modules/mase-gradient-builder.js",
      "assets/js/modules/mase-compatibility.js",
      "assets/js/modules/mase-error-recovery.js",
      "assets/js/modules/mase-background-accessibility.js",
      "assets/js/modules/event-bus.js",
      "assets/js/modules/state-manager.js",
      "assets/js/modules/palette-manager.js",
      "assets/js/modules/template-manager.js",
      "assets/js/modules/preview-engine.js",
      "assets/js/modules/animations.js",
      "assets/js/modules/animation-timeline.js",
      "assets/js/modules/animation-presets.js",
      "assets/js/modules/color-system.js",
      "assets/js/modules/typography.js",
      "assets/js/modules/api-client.js",
      "assets/js/modules/ai-suggestions.js",
      "assets/js/modules/event-adapter.js",
      "assets/js/modules/main-admin.js",
      "assets/js/modules/index.js"
    ],
    "non_existent_files": [
      {
        "file": "assets/js/mase-admin-live-preview.js",
        "status": "DOES NOT EXIST",
        "reason": "Live preview is integrated into mase-admin.js to prevent duplicate event handlers"
      }
    ]
  },
  
  "css_files": {
    "main_stylesheets": [
      "assets/css/mase-admin.css - Main styles + global dark mode FAB",
      "assets/css/mase-palettes.css",
      "assets/css/mase-templates.css",
      "assets/css/mase-accessibility.css",
      "assets/css/mase-responsive.css",
      "assets/css/mase-pattern-library.css",
      "assets/css/mase-animation-editor.css"
    ]
  },
  
  "test_files": {
    "e2e_tests": [
      "tests/e2e/comprehensive-functionality-test.spec.js",
      "tests/e2e/quick-smoke-test.spec.js",
      "tests/e2e/global-setup.js",
      "tests/e2e/helpers/auth.js"
    ],
    "visual_tests": [
      "tests/visual-interactive/**/* - Visual regression and interactive testing"
    ],
    "cypress_tests": [
      "tests/cypress/e2e/mase-basic.cy.js",
      "tests/cypress/support/commands.js",
      "tests/cypress/support/e2e.js"
    ]
  },
  
  "key_directories": {
    "includes": "PHP backend classes and admin functionality",
    "assets/js": "JavaScript files for admin interface",
    "assets/css": "Stylesheets for admin styling",
    "tests": "Testing suites (e2e, visual-interactive, cypress, benchmarks)",
    "docs": "Documentation and guides",
    "languages": "Localization files"
  },
  
  "global_dark_mode_architecture": {
    "status": "FIXED - Ready for testing",
    "components": {
      "php_enqueue": {
        "file": "includes/class-mase-admin.php",
        "method": "enqueue_global_dark_mode($hook)",
        "line": 157,
        "loads_on": "ALL admin pages",
        "assets": [
          "mase-global-dark-mode.css (reuses mase-admin.css)",
          "mase-global-dark-mode.js"
        ],
        "localized_data": {
          "object": "maseGlobalDarkMode",
          "ajaxUrl": "admin-ajax.php",
          "nonce": "wp_create_nonce('mase_toggle_dark_mode') - CORRECT"
        }
      },
      "php_render": {
        "file": "includes/class-mase-admin.php",
        "method": "render_global_dark_mode_fab()",
        "line": 186,
        "hook": "admin_footer",
        "renders": "Floating action button with dashicons"
      },
      "php_handler": {
        "file": "includes/class-mase-admin.php",
        "method": "handle_ajax_toggle_dark_mode()",
        "line": 3465,
        "action": "wp_ajax_mase_toggle_dark_mode",
        "nonce_check": "check_ajax_referer('mase_toggle_dark_mode') - FIXED",
        "saves_to": "user_meta: mase_dark_mode_preference"
      },
      "javascript": {
        "file": "assets/js/mase-global-dark-mode.js",
        "object": "MASEGlobalDarkMode",
        "methods": [
          "init() - Initialize and load saved mode",
          "loadSavedMode() - Check localStorage and apply",
          "bindEvents() - FAB click + Ctrl+Shift+D keyboard shortcut",
          "toggle() - Switch between light/dark",
          "enableDarkMode(save) - Apply dark mode classes",
          "enableLightMode(save) - Remove dark mode classes",
          "saveToServer(mode) - AJAX call with CORRECT nonce"
        ],
        "ajax_call": {
          "action": "mase_toggle_dark_mode",
          "nonce": "maseGlobalDarkMode.nonce - CORRECT",
          "data": "mode: 'light' or 'dark'"
        }
      }
    },
    "flow": [
      "1. User clicks FAB or presses Ctrl+Shift+D",
      "2. JavaScript toggles classes: body.mase-dark-mode, html[data-theme='dark']",
      "3. JavaScript saves to localStorage (instant)",
      "4. JavaScript calls AJAX with CORRECT nonce",
      "5. PHP verifies nonce (NOW WORKS)",
      "6. PHP saves to user_meta",
      "7. On page load: Check localStorage â†’ Apply classes before render (FOUC prevention)"
    ]
  },
  
  "live_preview_architecture": {
    "integration": "Integrated into mase-admin.js as MASE.livePreview module",
    "not_separate_file": true,
    "primary_file": "assets/js/mase-admin.js",
    "module_name": "MASE.livePreview",
    "purpose": "Prevent duplicate event handlers and race conditions"
  },
  
  "asset_enqueue_mechanism": {
    "settings_page_only": {
      "hook": "admin_enqueue_scripts",
      "condition": "toplevel_page_mase-settings",
      "method": "enqueue_assets($hook)",
      "load_order": [
        "1. wp-color-picker",
        "2. mase-admin.css",
        "3. mase-palettes.css",
        "4. mase-templates.css",
        "5. mase-accessibility.css",
        "6. mase-responsive.css",
        "7. mase-asset-loader.js (FIRST)",
        "8. mase-admin.js (with live preview)",
        "9. mase-gradient-builder.js",
        "10. mase-pattern-library.css + .js",
        "11. mase-position-picker.js",
        "12. mase-compatibility.js",
        "13. mase-error-recovery.js",
        "14. mase-background-accessibility.js"
      ]
    },
    "all_admin_pages": {
      "hook": "admin_enqueue_scripts",
      "method": "enqueue_global_dark_mode($hook)",
      "loads": [
        "mase-global-dark-mode.css (reuses mase-admin.css)",
        "mase-global-dark-mode.js"
      ],
      "localized_data": "maseGlobalDarkMode with CORRECT nonce"
    }
  },
  
  "security_implementation": {
    "nonce_verification": "All AJAX handlers use check_ajax_referer()",
    "capability_checks": "All AJAX handlers verify current_user_can('manage_options')",
    "input_sanitization": "sanitize_text_field(), sanitize_hex_color(), absint()",
    "output_escaping": "esc_html(), esc_attr(), esc_url()",
    "dark_mode_nonce": "FIXED: Now uses 'mase_toggle_dark_mode' consistently"
  },
  
  "testing_recommendations": {
    "immediate_tests": [
      "1. Clear browser cache and localStorage",
      "2. Navigate to any WordPress admin page",
      "3. Verify FAB appears in bottom-right corner",
      "4. Click FAB - should toggle dark/light mode",
      "5. Check browser console - should see 'Dark mode preference saved to server'",
      "6. Refresh page - mode should persist",
      "7. Test keyboard shortcut: Ctrl+Shift+D",
      "8. Check Network tab - AJAX call should return 200 OK (not 403)"
    ],
    "verification_commands": [
      "Check localStorage: localStorage.getItem('mase_dark_mode')",
      "Check user meta: get_user_meta(get_current_user_id(), 'mase_dark_mode_preference', true)",
      "Check nonce: wp_verify_nonce($_POST['nonce'], 'mase_toggle_dark_mode')"
    ]
  }
}
