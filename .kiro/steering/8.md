---
inclusion: always
---

# Settings Save System - Do Not Modify

**CRITICAL: The settings save system has been fixed and must not be modified.**

## Fixed Components

### 1. JavaScript Validation
- **File:** `assets/js/mase-admin.js`
- **Status:** Validation removed from `saveSettings()` function
- **Reason:** Was blocking saves with false positives on numeric fields
- **DO NOT:** Re-add client-side validation before AJAX submission

### 2. PHP Save Functions
The following functions bypass full validation and use WordPress `update_option()` directly:

- `apply_palette()` - Applies color palettes
- `save_custom_palette()` - Saves custom palettes
- `delete_custom_palette()` - Deletes custom palettes
- `apply_template()` - Applies templates
- `save_custom_template()` - Saves custom templates
- `delete_custom_template()` - Deletes custom templates

**Reason:** Full validation was rejecting valid data in unrelated sections (e.g., `custom_backgrounds`)

**DO NOT:** Change these functions to use `$this->update_option()` instead of `update_option()`

### 3. Main Save Handler
- **File:** `includes/class-mase-admin.php`
- **Function:** `handle_ajax_save_settings()`
- **Status:** Uses `$this->settings->update_option()` with full validation
- **This is correct:** Main form save needs full validation

## Why This Architecture

1. **Palette/Template Application:** Only changes specific sections (colors), doesn't need full validation
2. **Form Save:** Changes all sections, needs full validation
3. **Validation Issues:** Complex nested structures (backgrounds, buttons) can fail validation even when valid

## If You Need to Modify

**Before making changes:**
1. Read this document completely
2. Test palette application: Change palette → Apply → Refresh → Verify colors changed
3. Test form save: Change any setting → Save → Refresh → Verify setting saved
4. Check console for validation errors

**If validation errors occur:**
- Check `wp-content/debug.log` for detailed error messages
- Validation errors will show which fields failed and why
- Fix the validation logic, not the save system

## Emergency Rollback

If saves stop working after modifications:

```php
// In apply_palette(), save_custom_palette(), etc.
// WRONG:
$result = $this->update_option( $current_settings );

// CORRECT:
$result = update_option( self::OPTION_NAME, $current_settings );
```
